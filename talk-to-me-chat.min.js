/* TalkToMeChat SDK v1.0.0 | (c) 2025 */
!function(e){"use strict";e.TalkToMeChat=class TalkToMeChat{constructor(e){if(!e.token)throw new Error('TalkToMe: token é obrigatório. new TalkToMeChat({ token: "..." })');this.token=e.token,this.wsUrl=e.wsUrl,this.config={},this.sessionId=this._generateId("session_"),this.userIdentifier=this._getOrSetLocalStorage("ttm_user_id",()=>Math.random().toString(36).substring(2,15)),this.userName=localStorage.getItem("ttm_user_name"),this.threadId=localStorage.getItem("ttm_thread_id"),this.ws=null,this.isOpen=!1,this.channelInactive=!1,this.librariesLoaded=!1,this.displayedMessages=new Set,this.messagesQueue=[],this.pendingWebSocketMessages=[],this.messagesLoaded=!1,this.isProcessingQueue=!1,this._unreadCount=0,this._waitingForHistory=!1,this.ui={},this.libs={Motion:null,lucide:null},this.theme={theme:"dark",name:"Chat",bodyColor:"#151619",icon:"message-circle",logo_url:null,wallpaper_url:null}}get isDark(){return"dark"===this.theme.theme}_generateId(e=""){return e+Math.random().toString(36).substring(2,15)+Date.now().toString(36)}_getOrSetLocalStorage(e,t){let s=localStorage.getItem(e);return s||(s=t(),localStorage.setItem(e,s)),s}async _loadScript(t,s,n){return e[s]?(n&&n(e[s]),Promise.resolve()):new Promise((i,a)=>{const o=document.createElement("script");o.src=t,o.onload=()=>{n&&n(e[s]),i()},o.onerror=()=>a(new Error(`Falha ao carregar ${t}`)),document.head.appendChild(o)})}async init(){await this._loadLibraries(),this._createUI(),this.ui.container&&(this.ui.container.style.display="none"),this._connectWebSocket()}async _loadLibraries(){if(!this.librariesLoaded)try{await Promise.all([this._loadScript("https://cdn.tailwindcss.com","tailwind",e=>{e&&(e.config={corePlugins:{preflight:!1}})}),this._loadScript("https://cdn.jsdelivr.net/npm/framer-motion@11/dist/framer-motion.js","Motion",e=>this.libs.Motion=e),this._loadScript("https://unpkg.com/lucide@latest","lucide",e=>this.libs.lucide=e)]),this.librariesLoaded=!0}catch(e){}}_connectWebSocket(){const e=`${this.wsUrl}/ws/session:${this.sessionId}/${this.threadId||"new"}?token=${this.token}`;this.ws=new WebSocket(e);const t=setTimeout(()=>{this.ws?.readyState===WebSocket.CONNECTING&&(this._closeWebSocket(),this.channelInactive=!0)},5e3);this.ws.onopen=()=>{clearTimeout(t),this.channelInactive=!1,this.ui.container&&(this.ui.container.style.display="block"),this._requestMetadata(),this.messagesLoaded||this._loadMessages()},this.ws.onerror=()=>{clearTimeout(t),this.ui.container&&(this.ui.container.style.display="none")},this.ws.onclose=e=>{clearTimeout(t),this.ws=null,this.ui.container&&(this.ui.container.style.display="none")},this.ws.onmessage=e=>this._handleWebSocketMessage(JSON.parse(e.data))}_handleWebSocketMessage(e){switch((e.external_id||e.data&&e.data.external_id)&&(this.threadId=e.external_id||e.data.external_id,localStorage.setItem("ttm_thread_id",this.threadId)),e.type){case"metadata":e.data&&this._handleMetadata(e.data);break;case"history":e.data?.messages&&e.data.messages.forEach(e=>this.pendingWebSocketMessages.push(e)),this._waitingForHistory=!1;break;case"message":this._handleIncomingMessage(e.data);break;case"presence":"typing"===e.data?.status&&this._displayPresence();break;case"error":this._closeWebSocket();break;case"finish":this._clearThreadData(),this._closeWebSocket(),setTimeout(()=>{alert("TENTANDO RECONEXÃO..."),this._connectWebSocket()},100)}}_handleIncomingMessage(e){this.messagesLoaded?(this._enqueueMessage(e,!0),this.isOpen||"customer"===e.origin||(this._unreadCount++,this._updateNotificationCounter())):this.pendingWebSocketMessages.push(e),this._clearPresence()}_sendMessage(t=null,s=null){const n=t||this.ui.inputField.value;(n||s)&&(this.channelInactive||(!t&&this.ui.inputField&&(this.ui.inputField.value="",this.ui.inputField.style.height="auto"),n&&this._enqueueMessage({text:n,origin:"customer",created_at:(new Date).toISOString(),timestamp:Date.now()}),this.ws&&this.ws.readyState===WebSocket.OPEN||this._connectWebSocket(),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"send_message",data:{token:this.token,name:this.userName,user_id:this.userIdentifier,text:n||null,metadata:{origin:e.location.host},thread_id:this.threadId}}))))}_closeWebSocket(){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.close(),this.ws=null,this.ui.container&&(this.ui.container.style.display="none")}_requestMetadata(){this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"metadata",data:{token:this.token}}))}_handleMetadata(e){this.config={name:e.name,...e,widget_style:e.widget_style},this.config.widget_style&&this._applyWidgetStyles(this.config.widget_style)}_clearThreadData(){["ttm_thread_id","ttm_user_id","ttm_user_name"].forEach(e=>localStorage.removeItem(e)),this.threadId=null,this.userName=null,this.messagesLoaded=!1,this.displayedMessages.clear(),this.messagesQueue=[],this.pendingWebSocketMessages=[],this.userIdentifier=this._generateId(),this._updateNotificationCounter(),this.ui.messagesContainer&&(this.ui.messagesContainer.innerHTML="")}async _loadMessages(){if(!this.messagesLoaded){if(this.threadId&&this.ws?.readyState===WebSocket.OPEN){this._waitingForHistory=!0,this.ws.send(JSON.stringify({type:"history",data:{thread_id:this.threadId,token:this.token}}));const e=3e3,t=Date.now();for(;this._waitingForHistory&&Date.now()-t<e;)await new Promise(e=>setTimeout(e,100))}this.messagesLoaded=!0,this.pendingWebSocketMessages.length>0&&(this.pendingWebSocketMessages.forEach(e=>this._enqueueMessage(e)),this.pendingWebSocketMessages=[])}}_applyWidgetStyles(e){Object.assign(this.theme,e),this._updateUITheme()}_updateUITheme(){if(!this.ui.chatWindow)return;const e=this.isDark,t=this._getThemeColors();this.theme.buttonColor&&(this.ui.chatWindow.style.background=this.theme.buttonColor);const s=this.ui.chatContent?.querySelector(".ttm-header");s&&(s.style.background=this.theme.headerColor,s.style.borderBottom=`1px solid ${t.border}`),this._renderHeaderAvatars(s,e);const n=this.ui.chatContent?.querySelectorAll(".ttm-msg-area");if(n.forEach(e=>{this.theme.wallpaper_url?(e.style.backgroundImage=`url(${this.theme.wallpaper_url})`,e.style.backgroundSize="cover"):e.style.background=this.theme.bodyColor}),this.ui.inputContainer&&(this.ui.inputContainer.style.background=t.inputBg),this.ui.inputField&&(this.ui.inputField.style.color=t.text,this._updatePlaceholderColor(t.placeholder)),this.ui.sendButton){this.ui.sendButton.style.background=t.inverseBg;const e=this.ui.sendButton.querySelector("svg");e&&(e.style.stroke=t.inverseText,e.style.color=t.inverseText)}this._renderLinkContainer(t),this.libs.lucide&&this.libs.lucide.createIcons()}_getThemeColors(){const e=this.isDark;return{bg:e?"#151619":"#ffffff",text:e?"#ffffff":"#000000",inverseBg:e?"#ffffff":"#000000",inverseText:e?"#000000":"#ffffff",border:e?"#565656":"#d1d5db",inputBg:e?"#212224":"#e9e9e9",placeholder:e?"#e5e7eb":"#0D0D0D",avatarBg:e?"#494949":"#d4d4d4"}}_renderHeaderAvatars(e,t){if(!e)return;const s=e.querySelector("h3"),n=e.querySelector(".ttm-avatars");n&&n.remove();const i=document.createElement("div");i.className="ttm-avatars flex ml-[10px] items-center mt-1";const a=(Array.isArray(this.theme.logos_url)?this.theme.logos_url:[]).filter(Boolean);a.length>0?a.forEach((e,t)=>{const s=document.createElement("div");s.className="w-[2.5rem] h-[2.5rem] rounded-full border-2 flex items-center justify-center flex-shrink-0",s.style.background=this._getThemeColors().avatarBg,t>0&&(s.style.marginLeft="-14px");const n=document.createElement("img");n.src=e,n.className="w-full h-full rounded-full object-cover",s.appendChild(n),i.appendChild(s)}):i.innerHTML=`\n                <div class="w-[2.5rem] h-[2.5rem] rounded-full border-2 flex items-center justify-center flex-shrink-0" style="background: ${this._getThemeColors().avatarBg}">\n                   <i data-lucide="user" class="size-5" style="color: ${t?"white":"black"}"></i>\n                </div>`,s?e.insertBefore(i,s):e.appendChild(i)}_renderLinkContainer(e){const t=this.ui.inputContainer?.parentElement;if(t&&(t.querySelector(".ttm-link-container")?.remove(),this.theme.link&&this.theme.link_label)){const s=document.createElement("div");s.className="ttm-link-container flex items-center justify-center rounded-lg mt-2 px-2 py-1 mx-auto w-fit gap-2",s.style.background=e.inputBg,s.innerHTML=`\n                <i data-lucide="link" style="width: 16px; height: 16px; color: ${e.text};"></i>\n                <a href="${this.theme.link}" target="_blank" class="text-sm no-underline" style="color: ${e.text};">${this.theme.link_label}</a>\n            `,t.appendChild(s)}}_injectCustomStyles(){const e=this.isDark,t=`\n            #ttm-chat-container * { box-sizing: border-box; }\n            .ttm-message-customer { justify-content: flex-end !important; }\n            .ttm-message { animation: ttm-slide-in 0.3s ease-in-out; }\n            #ttm-input::placeholder { color: ${e?"#e5e7eb":"#0D0D0D"} !important; }\n            @keyframes ttm-slide-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }\n \n            @keyframes ttm-pulse {\n            0% {\n                transform: scale(1);\n            }\n            50% {\n                transform: scale(1.1);\n            }\n            100% {\n                transform: scale(1);\n            }\n            }\n      \n         \n\n            #ttm-drop-zone.ttm-drag-over {\n            border-color: #3b82f6 !important;\n            background: ${e?"#1e3a5f":"#dbeafe"} !important;\n            transform: scale(1.02);\n            transition: all 0.2s ease;\n            }\n\n            #ttm-drop-zone {\n            transition: all 0.2s ease;\n            }\n            @keyframes ttm-drag-pulse {\n                0%, 100% {\n                    opacity: 1;\n                }\n                50% {\n                    opacity: 0.8;\n                }\n            }\n            #ttm-drop-zone.ttm-drag-over {\n            animation: ttm-drag-pulse 1s ease-in-out infinite;\n            }\n\n        \n\n            #ttm-input {\n            box-sizing: border-box !important;\n            overflow-y: auto !important;\n            font-family: inherit !important;\n            }\n    \n            #ttm-input::placeholder {\n            color: ${e?"#e5e7eb":"#0D0D0D"} !important;\n            }\n    \n            #ttm-messages::-webkit-scrollbar {\n            width: 6px;\n            }\n\n            #ttm-messages::-webkit-scrollbar-thumb {\n            background: ${e?"#404040":"#d1d5db"};\n            border-radius: 3px;\n            }\n\n            #ttm-messages {\n            -webkit-overflow-scrolling: touch;\n            overscroll-behavior: contain;\n            touch-action: pan-y;\n            overflow-y: scroll !important;\n            -webkit-transform: translateZ(0);\n            }\n    \n            #ttm-input::-webkit-scrollbar {\n            width: 8px;\n            }\n    \n            #ttm-input::-webkit-scrollbar-track {\n            background: transparent;\n            border-radius: 4px;\n            }\n    \n            #ttm-input::-webkit-scrollbar-thumb {\n            background: ${e?"#666":"#888"};\n            border-radius: 4px;\n            }\n\n            .ttm-agent-typing {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 4px;\n            }\n\n            .ttm-agent-typing-dot {\n            width: 8px;\n            height: 8px;\n            border-radius: 50%;\n            background-color: ${e?"#ffffff":"#000000"};\n            animation: ttm-typing-dot 1.4s infinite ease-in-out;\n            }\n\n            .ttm-agent-typing-dot:nth-child(1) {\n                animation-delay: 0s;\n            }\n\n            .ttm-agent-typing-dot:nth-child(2) {\n                animation-delay: 0.2s;\n            }\n\n            .ttm-agent-typing-dot:nth-child(3) {\n                animation-delay: 0.4s;\n            }\n\n            @keyframes ttm-typing-dot {\n                0%, 60%, 100% {\n                    opacity: 0.3;\n                    transform: scale(0.8);\n                }\n                30% {\n                    opacity: 1;\n                    transform: scale(1);\n                }\n            }\n\n\n            @keyframes ttm-pulse {\n    \n            @media (max-width: 480px) {\n            #ttm-chat-window[data-open="true"] {\n                width: calc(100vw - 20px) !important;\n                height: calc(100vh - 100px) !important;\n                right: 10px !important;\n            }\n            }\n    \n            [data-lucide] {\n            display: inline-block;\n            }\n\n        `;let s=document.querySelector("style[data-ttm-styles]");s||(s=document.createElement("style"),s.setAttribute("data-ttm-styles","true"),document.head.appendChild(s)),s.textContent=t}_updatePlaceholderColor(e){const t=document.querySelector("style[data-ttm-styles]");t&&(t.textContent=t.textContent.replace(/(#ttm-input::placeholder\s*\{[^}]*color:\s*)[^;]+(;)/,`$1${e}$2`))}_createUI(){this._injectCustomStyles(),this.ui.container=document.createElement("div"),this.ui.container.id="ttm-chat-container",this._createVisualizerOverlay();const e=this._getThemeColors();this.ui.container.innerHTML=`\n          <div id="ttm-chat-window" class="fixed flex flex-col border-2 shadow-2xl cursor-pointer"\n              style="background: ${this.theme.buttonColor}; bottom: 20px; right: 20px; border-radius: 24px; z-index: 9999; border: none; width: 46px; height: 46px;">\n              \n              <div id="ttm-button-icon" class="absolute inset-0 flex items-center justify-center">\n                  <i data-lucide="${this.theme.icon}" class="size-5" style="color: ${e.text}"></i>\n              </div>\n              \n              <div class="ttm-notification-counter absolute hidden flex items-center justify-center bg-red-500 rounded-full border-2 border-white px-1.5 h-5" style="top: -4px; right: 4px; z-index: 10000; transform: translate(6px, -6px);">\n                  <span class="text-[11px] text-white font-semibold leading-none">0</span>\n              </div>\n\n              <div id="ttm-chat-content" class="flex flex-col h-full" style="opacity: 0; pointer-events: none; display: none;">\n                  <div class="ttm-header p-1 flex items-start gap-2 flex-shrink-0" style="background: ${this.theme.headerColor}; border-bottom: 1px solid ${e.border};">\n                      <h3 class="flex-1 text-base font-normal mt-[0.9rem] ml-1" style="color: ${e.text}">${this.theme.name}</h3>\n                      <button id="ttm-close-button" class="w-9 h-9 bg-transparent flex items-center justify-center self-end m-1.5 border-none cursor-pointer hover:opacity-90">\n                          <i data-lucide="x" style="width: 16px; color: ${e.text}"></i>\n                      </button>\n                  </div>\n\n                  ${null===this.userName?`\n                  <div id="ttm-first-step-container" class="flex-1 flex overflow-y-auto flex-col items-center justify-center">\n                      <input type="text" id="ttm-first-step-input" class="w-[80%] h-12 border-none text-center rounded-lg mt-3" placeholder="Qual é o seu nome?" \n                             style="color: ${e.text}; background: ${e.inputBg}">\n                      <button type="button" id="ttm-first-step-button" class="mt-2 rounded-lg px-4 py-1 border-none cursor-pointer" \n                              style="background: ${e.inverseBg}; color: ${e.inverseText}">Ok</button>\n                  </div>`:""}\n\n                  <div id="ttm-messages-wrapper" class="flex-1 flex overflow-y-auto flex-col" style="display: ${this.userName?"flex":"none"}">\n                      <div id="ttm-messages" class="ttm-msg-area flex-1 p-2 flex flex-col gap-2 bg-transparent overflow-y-scroll"></div>\n                      \n                      <div class="p-2 flex-shrink-0">\n                          <div id="ttm-input-container" class="flex flex-col p-1 gap-0 rounded-[1.5rem]" style="background: ${e.inputBg}">\n                              <textarea id="ttm-input" class="flex p-1 w-full border-none bg-transparent resize-none outline-none text-sm max-h-[100px]" \n                                        style="color: ${e.text}; padding-left: 1rem; padding-top:10px" placeholder="Digite aqui..."></textarea>\n                              <div class="flex justify-between w-full gap-2">\n                                  <div class="flex-1"></div> <button id="ttm-send-button" class="w-8 h-8 rounded-full flex items-center justify-center m-1.5 border-none cursor-pointer"\n                                          style="background: ${e.inverseBg}">\n                                      <i data-lucide="arrow-up" style="width: 16px; color: ${e.inverseText}"></i>\n                                  </button>\n                              </div>\n                          </div>\n                      </div>\n                  </div>\n              </div>\n          </div>\n      `,document.body.appendChild(this.ui.container),this._bindUIEvents(),this.libs.lucide&&this.libs.lucide.createIcons()}_bindUIEvents(){["chat-window","button-icon","input","chat-content","send-button","messages","close-button","input-container"].forEach(e=>this.ui[e.replace(/-([a-z])/g,e=>e[1].toUpperCase())]=document.getElementById(`ttm-${e}`)),this.ui.messagesContainer=document.getElementById("ttm-messages"),this.ui.chatWindow.addEventListener("click",()=>!this.isOpen&&this._openChat()),this.ui.closeButton.addEventListener("click",e=>{e.stopPropagation(),this._closeChat()}),this.ui.sendButton?.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this._sendMessage()}),this.ui.input?.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this._sendMessage())}),this.ui.input?.addEventListener("input",e=>{e.target.style.height="30px",e.target.style.height=Math.min(e.target.scrollHeight,100)+"px"});const e=document.getElementById("ttm-first-step-button"),t=document.getElementById("ttm-first-step-input");e&&(e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const s=t.value.trim();s&&(this.userName=s,localStorage.setItem("ttm_user_name",s),document.getElementById("ttm-first-step-container").style.display="none",document.getElementById("ttm-messages-wrapper").style.display="flex")}),t.addEventListener("keypress",t=>{"Enter"===t.key&&e.click()}))}_openChat(){this.isOpen=!0,this.ui.chatWindow.classList.add("overflow-hidden"),this.ui.chatWindow.setAttribute("data-open","true"),this.ui.chatWindow.style.cursor="default",this.ui.buttonIcon.style.opacity="0",this.ui.buttonIcon.style.display="none",this.ui.chatContent.style.display="flex",this.ui.chatWindow.style.transition="all 0.35s ease",this.ui.chatWindow.style.width="343px",this.ui.chatWindow.style.height="550px",this.ui.chatWindow.style.borderRadius="14px",this.ui.chatContent.style.opacity="1",this.ui.chatContent.style.pointerEvents="auto",this._resetNotificationCounter(),this.ws||this.channelInactive||this._connectWebSocket()}_closeChat(){this.isOpen=!1,this.ui.chatWindow.setAttribute("data-open","false"),this.ui.chatWindow.style.cursor="pointer",this.ui.chatContent.style.opacity="0",this.ui.chatContent.style.pointerEvents="none",this.ui.chatContent.style.display="none",this.ui.buttonIcon.style.display="flex",this.ui.buttonIcon.style.opacity="1",this.ui.chatWindow.style.width="44px",this.ui.chatWindow.style.height="44px",this.ui.chatWindow.style.borderRadius="24px",this.ui.chatWindow.classList.remove("overflow-hidden"),this.libs.lucide?.createIcons()}async _processMessageQueue(){if(!this.isProcessingQueue&&0!==this.messagesQueue.length){for(this.isProcessingQueue=!0;this.messagesQueue.length>0;){const e=this.messagesQueue.shift();this._displayMessage(e),e.isNewMessage&&await new Promise(e=>setTimeout(e,500))}this.isProcessingQueue=!1}}_enqueueMessage(e,t=!1){const s=`${e.text||""}_${e.origin}_${e.created_at||e.timestamp}`;this.displayedMessages.has(s)||(this.displayedMessages.add(s),e.isNewMessage=t,this.messagesQueue.push(e),this._processMessageQueue())}_displayMessage(e){const t=this.isDark,s="customer"===e.origin,n=!s;let i,a;n?(i=t?"#000000":"#ebeaea",a=t?"#ffffff":"#000000"):(i=t?"#ffffff":"#000000",a=t?"#000000":"#ffffff");const o=document.createElement("div");o.className="ttm-message "+(s?"ttm-message-customer":"ttm-message-agent");let r="";if(e.media){const n=e.media.content_type||"";n.startsWith("image")?r+=this._renderImage(e.media):n.startsWith("video")?r+=this._renderVideo(e.media):n.startsWith("audio")?r+=this._renderAudio(e.media,s,t):r+=this._renderFile(e.media,a,t)}e.text&&(r+=`<p class="text-sm m-0 whitespace-normal break-words">${e.text}</p>`),"button"===e.interactive?.type&&(r+=this._renderButtons(e.interactive.options,t)),o.innerHTML=`\n          <div class="relative w-fit max-w-[80%] h-full rounded-xl px-2 py-2 break-words"\n               style="background: ${i}; color: ${a}; border: 1px solid ${t&&s||n&&!t?"#d1d5db":"transparent"}">\n             ${r}\n          </div>\n          ${n&&e.metadata?.ai_agent?.name?`<span class="text-xs mt-1 block" style="opacity: 0.7; color: ${t?"#fff":"#000"}">${e.metadata.ai_agent.name}</span>`:""}\n      `,this.ui.messagesContainer.appendChild(o),this.libs.lucide?.createIcons(),this._attachMessageListeners(o),requestAnimationFrame(()=>this.ui.messagesContainer.scrollTop=this.ui.messagesContainer.scrollHeight)}_renderImage(e){return`<img src="${e.file}" class="w-full max-w-[280px] h-auto ttm-media-visualizer cursor-pointer rounded-md object-cover" data-media-src="${e.file}" data-media-type="image"/>`}_renderVideo(e){return`<video src="${e.file}" class="w-full max-w-[280px] h-auto ttm-media-visualizer cursor-pointer rounded-md object-cover" data-media-src="${e.file}" data-media-type="video" controls></video>`}_renderFile(e,t,s){return`\n         <div class="flex items-center gap-3 p-1 rounded-lg max-w-[280px]">\n            <div style="background: ${s?"#1a1a1a":"#e9e9e9"}" class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0">\n                <i data-lucide="file" style="width: 20px; color: ${s?"#ffffff":"#000000"}"></i>\n            </div>\n            <div class="flex-1 min-w-0 flex flex-col">\n                <span class="text-sm font-medium truncate">${e.file.split("/").pop().split("?")[0]||"Arquivo"}</span>\n                <span class="text-xs opacity-70">${e.content_type||"Documento"}</span>\n            </div>\n            <a href="${e.file}" class="ttm-download-btn w-8 h-8 flex items-center justify-center" download>\n                <i data-lucide="download" style="width: 18px; color: ${t}"></i>\n            </a>\n         </div>`}_renderButtons(e,t){const s=t?"#ffffff":"#181818",n=t?"#000000":"#ffffff";return`<div class="flex mt-2 flex-col gap-1">\n            ${e.map(e=>`\n                <button class="w-full px-6 py-2 rounded-lg cursor-pointer border-none" \n                        style="background: ${s}; color: ${n}" data-option-label="${e.label}">\n                    ${e.label}\n                </button>\n            `).join("")}\n        </div>`}_renderAudio(e,t,s){const n=s?"#000000":"#d1d5db";return`\n        <div class="ttm-audio-player flex items-center gap-2" style="width: 220px;">\n            <button class="ttm-audio-play-btn w-8 h-8 rounded-full flex items-center justify-center border-none cursor-pointer" \n                    style="background: ${t?s?"#1a1a1a":"#ffffff":s?"#ffffff":"#000000"}; color: ${t?s?"#ffffff":"#000000":s?"#000000":"#ffffff"}">\n                 <i data-lucide="play" class="size-4 ml-[2px]"></i>\n            </button>\n            <div class="flex-1 flex flex-col gap-1">\n                <div class="ttm-audio-waveform h-8 flex items-center justify-between gap-[2px] cursor-pointer">\n                    ${Array.from({length:30}).map((e,t)=>`<div class="ttm-waveform-bar flex-1 h-[20%] rounded-[2px] transition-all" style="background: ${n}" data-index="${t}"></div>`).join("")}\n                </div>\n                <div class="flex justify-end text-[10px] opacity-70 font-mono">\n                    <span class="current">0:00</span> / <span class="duration">0:00</span>\n                </div>\n            </div>\n            <audio src="${e.file}" class="ttm-audio-element hidden" preload="metadata"></audio>\n        </div>`}_attachMessageListeners(e){e.querySelectorAll("button[data-option-label]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),this._sendMessage(e.dataset.optionLabel)})});const t=e.querySelector(".ttm-audio-player");t&&this._initSingleAudioPlayer(t)}async _initSingleAudioPlayer(e){if(e.dataset.ready)return;e.dataset.ready="true";const t=e.querySelector("audio"),s=e.querySelector(".ttm-audio-play-btn"),n=e.querySelector(".ttm-audio-waveform"),i=n.querySelectorAll(".ttm-waveform-bar"),a=e.querySelector(".current"),o=e.querySelector(".duration"),r=s.querySelector("i");i.forEach(e=>e.style.height=`${Math.floor(60*Math.random()+20)}%`);const l=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`;t.addEventListener("loadedmetadata",()=>o.textContent=l(t.duration)),t.addEventListener("timeupdate",()=>{a.textContent=l(t.currentTime);const e=t.currentTime/t.duration,s=Math.ceil(e*i.length);i.forEach((e,t)=>e.style.opacity=t<s?"1":"0.4")}),t.addEventListener("ended",()=>{r.setAttribute("data-lucide","play"),this.libs.lucide?.createIcons(),i.forEach(e=>e.style.opacity="0.4")}),s.addEventListener("click",e=>{e.stopPropagation(),t.paused?(document.querySelectorAll("audio").forEach(e=>{e!==t&&(e.pause(),e.currentTime=0)}),document.querySelectorAll(".ttm-audio-play-btn i").forEach(e=>e.setAttribute("data-lucide","play")),t.play(),r.setAttribute("data-lucide","pause")):(t.pause(),r.setAttribute("data-lucide","play")),this.libs.lucide?.createIcons()}),n.addEventListener("click",e=>{const s=n.getBoundingClientRect(),i=(e.clientX-s.left)/s.width;t.duration&&(t.currentTime=i*t.duration)})}_createVisualizerOverlay(){const e=document.createElement("div");e.id="ttm-visualizer",e.style.display="none",e.className="fixed inset-0 z-[99999] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm",e.innerHTML='\n            <button class="absolute top-4 right-4 text-white"><i data-lucide="x" class="size-8"></i></button>\n            <div id="ttm-visualizer-content" class="max-w-full max-h-full"></div>\n        ',document.body.appendChild(e);const t=()=>e.style.display="none";e.querySelector("button").onclick=t,e.onclick=s=>{s.target===e&&t()},document.addEventListener("click",t=>{if(t.target.classList.contains("ttm-media-visualizer")&&"VIDEO"!==t.target.tagName){const s=t.target.dataset.mediaSrc;s&&(e.querySelector("#ttm-visualizer-content").innerHTML=`<img src="${s}" class="max-w-[90vw] max-h-[90vh] rounded-lg shadow-2xl">`,e.style.display="flex",this.libs.lucide?.createIcons())}})}_updateNotificationCounter(){const e=this.ui.container?.querySelector(".ttm-notification-counter");e&&(this._unreadCount>0?(e.querySelector("span").textContent=this._unreadCount,e.classList.remove("hidden")):e.classList.add("hidden"))}_resetNotificationCounter(){this._unreadCount=0,this._updateNotificationCounter()}_displayPresence(){this._clearPresence();const e=document.createElement("div");e.className="ttm-presence ml-2 mb-2";const t=this.isDark?"#000000":"#ebeaea";e.innerHTML=`\n           <div class="px-3 py-2 rounded-xl w-fit" style="background: ${t}">\n              <div class="ttm-agent-typing flex gap-1">\n                  <div class="w-1.5 h-1.5 rounded-full bg-gray-400 animate-bounce"></div>\n                  <div class="w-1.5 h-1.5 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 0.1s"></div>\n                  <div class="w-1.5 h-1.5 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 0.2s"></div>\n             </div>\n            </div>`,this.ui.messagesContainer.appendChild(e),this.ui.messagesContainer.scrollTop=this.ui.messagesContainer.scrollHeight}_clearPresence(){this.ui.messagesContainer?.querySelector(".ttm-presence")?.remove()}}}(window);