/* TalkToMeChat SDK v1.0.0 | (c) 2025 */
!function(t){"use strict";t.TalkToMeChat=class TalkToMeChat{constructor(t){if(this.token=t.token,!this.token)throw new Error('TalkToMe: token é obrigatório. Configure no constructor: new TalkToMeChat({ token: "..." })');this.wsUrl=t.wsUrl,this.theme=null,this.threadId=localStorage.getItem("ttm_thread_id")||null,this.ws=null,this.sessionId=this._generateSessionId(),this.isOpen=!1,this.userIdentifier=this._getUserIdentifier(),this.container=null,this.chatWindow=null,this.messagesContainer=null,this.inputField=null,this.librariesLoaded=!1,this.Motion=null,this.lucide=null,this.displayedMessages=new Set,this.messagesLoaded=!1,this.pendingWebSocketMessages=[],this.messagesQueue=[],this.isProcessingQueue=!1,this._unreadCount=0,this._waitingForHistory=!1,this.channelInactive=!1}async init(){await this._loadLibraries(),this.theme={theme:"dark",name:"Chat",bodyColor:"#151619",icon:"message-circle",logo_url:null,wallpaper_url:null},this._createUI(),this.container&&(this.container.style.display="none"),this._connectWebSocket()}_generateSessionId(){return"session_"+Math.random().toString(36).substring(2,15)+Date.now().toString(36)}_getUserIdentifier(){let t=localStorage.getItem("ttm_user_id");return t||(t=Math.random().toString(36).substring(2,15),localStorage.setItem("ttm_user_id",t)),t}async _loadLibraries(){if(!this.librariesLoaded)try{await Promise.all([this._loadTailwind(),this._loadFramerMotion(),this._loadLucide()]),this.librariesLoaded=!0}catch(t){}}_loadTailwind(){return new Promise((e,n)=>{if(document.querySelector('script[src*="tailwindcss"]'))return void e();const i=document.createElement("script");i.src="https://cdn.tailwindcss.com",i.onload=()=>{t.tailwind&&(t.tailwind.config={corePlugins:{preflight:!1}}),e()},i.onerror=()=>n(new Error("Falha ao carregar Tailwind CSS")),document.head.appendChild(i)})}_loadFramerMotion(){return new Promise((e,n)=>{if(t.Motion)return this.Motion=t.Motion,void e();const i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/framer-motion@11/dist/framer-motion.js",i.onload=()=>{this.Motion=t.Motion,e()},i.onerror=()=>n(new Error("Falha ao carregar Framer Motion")),document.head.appendChild(i)})}_loadLucide(){return new Promise((e,n)=>{if(t.lucide)return this.lucide=t.lucide,void e();const i=document.createElement("script");i.src="https://unpkg.com/lucide@latest",i.onload=()=>{this.lucide=t.lucide,e()},i.onerror=()=>n(new Error("Falha ao carregar Lucide")),document.head.appendChild(i)})}_connectWebSocket(){const t=`${this.wsUrl}/ws/session:${this.sessionId}/${this.threadId||"new"}?token=${this.token}`;this.ws=new WebSocket(t);const e=setTimeout(()=>{this.ws&&this.ws.readyState===WebSocket.CONNECTING&&(this.ws.close(),this.ws=null,this.channelInactive=!0,this.container&&(this.container.style.display="none"))},5e3);this.ws.onopen=()=>{clearTimeout(e),this.channelInactive=!1,this.container&&this.ws&&(this.container.style.display="block"),this._requestMetadata(),this.messagesLoaded||this._loadMessages()},this.ws.onerror=t=>{clearTimeout(e),this.container&&(this.container.style.display="none")},this.ws.onclose=t=>{clearTimeout(e),this.ws=null,this.container&&(this.container.style.display="none")},this.ws.onmessage=t=>{const e=JSON.parse(t.data);if("metadata"===e.type&&e.data)this._handleMetadata(e.data);else{if("history"===e.type&&e.data){const t=e.data.id;return t&&(this.threadId=t,localStorage.setItem("ttm_thread_id",this.threadId)),e.data.messages&&Array.isArray(e.data.messages)&&e.data.messages.forEach(t=>{this.pendingWebSocketMessages.push(t)}),void(this._waitingForHistory=!1)}if("message"===e.type&&e.data){const t=e.data,n=t.thread_id;n&&(this.threadId=n,localStorage.setItem("ttm_thread_id",this.threadId)),this.messagesLoaded?(this._enqueueMessage(t,!0),this.isOpen||"customer"===t.origin||(this._unreadCount++,this._updateNotificationCounter())):this.pendingWebSocketMessages.push(t),this._clearPresence()}"presence"===e.type&&"typing"===e.data.status&&this._displayPresence(),"error"===e.type&&this._closeWebSocket(),"finish"===e.type&&(this._clearThreadData(),this._closeWebSocket(),this._connectWebSocket())}}}_requestMetadata(){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"metadata",data:{token:this.token}}))}_handleMetadata(t){this.config={name:t.name,...t.data,metadata:t.data,widget_style:t.data.widget_style},this.config.widget_style&&this._applyWidgetStyles(this.config.widget_style)}_applyWidgetStyles(t){this.theme={...this.theme,...t,name:this.config.name||this.theme.name,theme:t.theme||this.theme.theme,bodyColor:t.bodyColor||this.theme.bodyColor,headerColor:t.headerColor||this.theme.headerColor,buttonColor:t.buttonColor||this.theme.buttonColor,link:t.link||this.theme.link,link_label:t.link_label||this.theme.link_label,icon:t.icon||this.theme.icon,logos_url:t.logos||this.theme.logos_url,wallpaper_url:t.wallpaper||this.theme.wallpaper_url},this._updateUIWithNewTheme();const e="dark"===this.theme.theme;this.chatWindow&&this.theme.buttonColor&&(this.chatWindow.style.background=this.theme.buttonColor);const n=this.chatContent?.querySelector(".p-1.flex.items-start.gap-2");if(n){n.style.background=this.theme.headerColor;const t="dark"===this.theme.theme,e=n.querySelector("h3");if(n.querySelectorAll(".mt-1.w-\\[2\\.5rem\\].h-\\[2\\.5rem\\].rounded-full.border-2").forEach(t=>{t.remove()}),Array.isArray(this.theme.logos_url)&&this.theme.logos_url.length>0){const i=document.createElement("div");i.className="flex ml-[10px] items-center",i.style.marginTop="0.25rem",this.theme.logos_url.forEach((e,n)=>{const s=document.createElement("div");s.className="w-[2.5rem] h-[2.5rem] rounded-full border-2 flex items-center justify-center flex-shrink-0",s.style.background=t?"#494949":"#d4d4d4",n>0&&(s.style.marginLeft="-14px");const a=document.createElement("img");a.src=e,a.alt="Logo",a.className="w-[2.5rem] h-[2.5rem] rounded-full object-cover",s.appendChild(a),i.appendChild(s)}),e?n.insertBefore(i,e):n.appendChild(i)}else{const i=document.createElement("div");i.className="mt-1 ml-3 w-[2.5rem] h-[2.5rem] rounded-full border-2 flex items-center justify-center flex-shrink-0",i.style.background=t?"#494949":"#d4d4d4",i.innerHTML=`\n              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${t?"#ffffff":"#000000"}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="size-5"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>\n            `,e?n.insertBefore(i,e):n.appendChild(i)}}const i=this.chatContent?.querySelector(".flex-1.flex.overflow-y-auto");i&&(this.theme.wallpaper_url?(i.style.backgroundImage=`url(${this.theme.wallpaper_url})`,i.style.backgroundSize="cover",i.style.backgroundPosition="center"):i.style.background=this.theme.bodyColor);const s=this.chatContent?.querySelector(".flex.flex-col.p-1.gap-0");if(s&&(s.style.background=e?"#212224":"#e9e9e9"),this.inputField){this.inputField.style.color=e?"#ffffff":"#000000";const t=document.querySelector("style[data-ttm-styles]");if(t){const n=e?"#e5e7eb":"#0D0D0D";t.textContent=t.textContent.replace(/(#ttm-input::placeholder\s*\{[^}]*color:\s*)[^;]+(;)/,`$1${n}$2`)}}if(this.sendButton){this.sendButton.style.background=e?"#ffffff":"#000000";const t=this.sendButton.querySelector("svg");t&&(t.style.stroke=e?"#000000":"#ffffff",t.style.color=e?"#000000":"#ffffff")}const a=s?.parentElement;if(a){const t=a.querySelector(".ttm-link-container");if(t&&t.remove(),this.theme.link&&this.theme.link_label){const t=document.createElement("div");t.className="ttm-link-container flex flex-row items-center justify-center rounded-lg mt-2 px-2 py-1 mx-auto w-fit gap-2",t.style.background=e?"#212223":"#e9e9e9",t.innerHTML=`\n              <i data-lucide="link" style="width: 16px; height: 16px; color: ${e?"#ffffff":"#000000"};"></i>\n              <a href="${this.theme.link}" target="_blank" class="text-sm" style="color: ${e?"#ffffff":"#000000"}; text-decoration: none;">\n                ${this.theme.link_label}\n              </a>\n            `,a.appendChild(t),this.lucide?.createIcons()}}this.lucide&&this.lucide.createIcons()}async _sendMessage(e=null,n=null){const i=e||this.inputField.value,s=t.location.hostname||t.location.host||"",a=`user_${this.userIdentifier}_${s}`;if(i&&!this.channelInactive){if(e||(this.inputField.value="",this.inputField.style.height="auto",this._updateSendButtonIcon()),i){const t={text:i||null,origin:"customer",created_at:(new Date).toISOString(),timestamp:(new Date).getTime()};this._enqueueMessage(t),this._processMessageQueue()}if(!this.ws||this.ws.readyState!==WebSocket.OPEN){if(this.channelInactive)return;this._connectWebSocket(),await new Promise(t=>setTimeout(t,1e3))}this.ws.send(JSON.stringify({type:"send_message",data:{token:this.token,name:a,user_id:this.userIdentifier,text:i||null,metadata:{origin:s},thread_id:this.threadId}}))}}_initAudioPlayers(){document.querySelectorAll(".ttm-audio-player").forEach(async e=>{const n=e.querySelector(".ttm-audio-play-btn"),i=e.querySelector(".ttm-audio-element"),s=e.querySelector(".ttm-audio-waveform"),a=e.querySelector(".ttm-audio-current-time"),o=e.querySelector(".ttm-audio-duration"),r=e.closest(".ttm-message-talk-to-me"),l=e.closest(".ttm-message-customer");if(e.dataset.waveformProcessed)return;e.dataset.waveformProcessed="true";const d=s.querySelector(".ttm-waveform-bar"),c=t.getComputedStyle(d).backgroundColor,h=c.includes("0, 0, 0")||c.includes("rgb(0");let u=!1;const m=i.querySelector("source").src,p=await this._generateWaveformData(m,30),f=s.querySelectorAll(".ttm-waveform-bar");p.forEach((t,e)=>{f[e]&&(f[e].style.height=`${t}%`)});const g=t=>`${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,"0")}`;i.load(),i.addEventListener("loadedmetadata",()=>{o.textContent=g(i.duration)}),i.addEventListener("timeupdate",()=>{const t=i.currentTime/i.duration*100,e=s.querySelectorAll(".ttm-waveform-bar"),n=Math.floor(t/100*e.length);e.forEach((t,e)=>{t.style.background=e<n?r?h?"#ffffff":"#000000":l?h?"#000000":"#ffffff":"#909090":"#909090"}),a.textContent=g(i.currentTime)}),i.addEventListener("ended",()=>{u=!1;const t=n.querySelector("i, svg");t&&(t.setAttribute("data-lucide","play"),t.style.marginLeft="2px"),s.querySelectorAll(".ttm-waveform-bar").forEach(t=>{t.style.background="#909090"}),a.textContent="0:00",this.lucide.createIcons()}),n.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const e=n.querySelector("i, svg");u?(i.pause(),e.setAttribute("data-lucide","play"),e.style.marginLeft="2px"):(document.querySelectorAll(".ttm-audio-element").forEach(t=>{if(t!==i){t.pause();const e=t.closest(".ttm-audio-player").querySelector(".ttm-audio-play-btn").querySelector("i, svg");e&&(e.setAttribute("data-lucide","play"),e.style.marginLeft="2px")}}),i.play(),e.setAttribute("data-lucide","pause"),e.style.marginLeft="0"),u=!u,this.lucide.createIcons()}),s.addEventListener("click",t=>{const e=s.getBoundingClientRect(),n=(t.clientX-e.left)/e.width;i.currentTime=n*i.duration})})}async _generateWaveformData(e,n=30){const i=await fetch(e),s=await i.arrayBuffer(),a=new(t.AudioContext||t.webkitAudioContext),o=(await a.decodeAudioData(s)).getChannelData(0),r=n,l=Math.floor(o.length/r),d=[];for(let t=0;t<r;t++){let e=l*t,n=0;for(let t=0;t<l;t++)n+=Math.abs(o[e+t]);d.push(n/l)}const c=Math.max(...d),h=Math.min(...d),u=c-h,m=d.map(t=>{if(0===u)return 20;const e=(t-h)/u;return Math.floor(60*e)+20});return a.close(),m}_audioRecorder(t){const e=["audio/ogg; codecs=opus","audio/webm; codecs=opus","audio/webm"].find(t=>MediaRecorder.isTypeSupported(t))||"",n=new MediaRecorder(t,{mimeType:e});let i=0;return this.recordingInterval=setInterval(()=>{i++;const t=`${Math.floor(i/60)}:${(i%60).toString().padStart(2,"0")}`;this._setRecordingButtonStyle(!0,t)},1e3),this._setRecordingButtonStyle(!0,"0:00"),n.addEventListener("dataavailable",t=>{if(t.data.size>0){const n=e.includes("ogg")?"ogg":"webm",i=new File([t.data],`audio.${n}`,{type:e});this._sendMessage(null,[i])}}),n.addEventListener("stop",()=>{this.recordingInterval&&(clearInterval(this.recordingInterval),this.recordingInterval=null),this._setRecordingButtonStyle(!1,"0:00"),this.activeRecorder=null,t.getTracks().forEach(t=>t.stop()),this.audioStream=null}),n.start(),n}_setRecordingButtonStyle(t,e="0:00"){if(!this.sendButton)return;const n="dark"===this.theme.theme;t?(this.originalPlaceholder||(this.originalPlaceholder=this.inputField.placeholder),this.sendButton.style.background="#ef4444",this.sendButton.style.animation="ttm-pulse 1.5s ease-in-out infinite",this.sendButton.innerHTML='<i data-lucide="stop" style="width: 16px; height: 16px; color: #ffffff;"></i>',this.inputField.placeholder=`Gravando... ${e}`):(this.sendButton.style.background=n?"#ffffff":"#000000",this.sendButton.style.border="none",this.sendButton.style.animation="",this.originalPlaceholder&&(this.inputField.placeholder=this.originalPlaceholder,this.originalPlaceholder=null),this._updateSendButtonIcon()),this.lucide.createIcons();const i=this.sendButton.querySelector("svg");i&&(i.style.stroke="#ffffff",i.style.color="#ffffff")}_closeWebSocket(){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.close(),this.ws=null,this.container&&(this.container.style.display="none")}_clearThreadData(){localStorage.removeItem("ttm_thread_id"),localStorage.removeItem("ttm_user_id"),this.threadId=null,this.messagesLoaded=!1,this.displayedMessages.clear(),this.messagesQueue=[],this.pendingWebSocketMessages=[],this.userIdentifier=this._getUserIdentifier(),this._updateNotificationCounter(),this.messagesContainer&&(this.messagesContainer.innerHTML="")}async _loadMessages(){if(!this.messagesLoaded){if(this.threadId&&this.ws&&this.ws.readyState===WebSocket.OPEN){this._waitingForHistory=!0,this.ws.send(JSON.stringify({type:"history",data:{thread_id:this.threadId,token:this.token}}));const t=3e3,e=Date.now();for(;this._waitingForHistory&&Date.now()-e<t;)await new Promise(t=>setTimeout(t,100))}this.messagesLoaded=!0,this._processPendingMessages()}}async _processMessageQueue(){if(!this.isProcessingQueue&&0!==this.messagesQueue.length){for(this.isProcessingQueue=!0;this.messagesQueue.length>0;){const t=this.messagesQueue.shift();this._displayMessage(t),t.isNewMessage&&await new Promise(t=>setTimeout(t,500))}this.isProcessingQueue=!1}}_enqueueMessage(t,e=!1){const n=`${t.text||""}_${t.origin}_${t.created_at||t.timestamp||""}`;this.displayedMessages.has(n)||(this.displayedMessages.add(n),t.isNewMessage=e,this.messagesQueue.push(t),this._processMessageQueue())}_notification(){const t=document.querySelector(".ttm-notification-counter");if(t){const e=this._unreadCount||0;e>0?(t.querySelector("span").textContent=e,t.classList.remove("hidden")):t.classList.add("hidden")}}_updateNotificationCounter(){const t=document.querySelector(".ttm-notification-counter");if(t){const e=this._unreadCount||0;e>0?(t.querySelector("span").textContent=e,t.classList.remove("hidden")):t.classList.add("hidden")}}_resetNotificationCounter(){this._unreadCount=0,this._updateNotificationCounter()}_processPendingMessages(){this.pendingWebSocketMessages.length>0&&(this.pendingWebSocketMessages.forEach(t=>{this._enqueueMessage(t)}),this.pendingWebSocketMessages=[])}_createUI(){const t="dark"===this.theme.theme;this._injectCustomStyles(),this.container=document.createElement("div"),this.container.id="ttm-chat-container",this._visualizer();const e=this.theme.icon||"message-circle";this.container.innerHTML=`\n                    <div\n                    id="ttm-chat-window"\n                    class="fixed flex flex-col border-2 shadow-2xl cursor-pointer"\n                    style="\n                        background: ${this.theme.buttonColor};\n                        bottom: 20px;\n                        right: 20px;\n                        border-radius: 24px;\n                        z-index: 9999;\n                        border: none;\n                        width: 46px;\n                        height: 46px;\n                    "\n                    aria-label="Abrir chat"\n                    >\n                    <div\n                        id="ttm-button-icon"\n                        type="button"\n                        class="absolute inset-0 flex items-center justify-center"\n                        style="opacity: 1;"\n                    >\n                        <i\n                        data-lucide="${e}"\n                        class="size-5"\n                        style="color: ${t?"#ffffff":"#000000"};"\n                        ></i>\n                    </div>\n                    <div class="ttm-notification-counter absolute min-w-[20px] h-5 px-1.5 rounded-full bg-red-500 hidden flex items-center justify-center border-2 border-white" style="top: -4px; right: 4px; z-index: 10000; transform: translate(6px, -6px);">\n                        <span class="text-[11px] text-white font-semibold leading-none">0</span>\n                    </div>\n                    <div\n                        id="ttm-chat-content"\n                        class="flex flex-col h-full"\n                        style="opacity: 0; pointer-events: none; display: none; position: relative;"\n                        >\n                        <div\n                        class="p-1 flex items-start gap-2 flex-shrink-0"\n                        style="background: ${this.theme.headerColor};  border-bottom: 1px solid ${t?"#565656":"#d1d5db"};"\n                        >\n                  \n                    <h3\n                        class="flex-1 text-base font-normal mt-[0.9rem] ml-1"\n                        style="color: ${t?"white":"black"};"\n                    >\n                        ${this.theme.name}\n                    </h3>\n                    <button\n                        id="ttm-close-button"\n                        class="w-9 h-9 bg-transparent flex items-center justify-center self-end m-1.5 border-none cursor-pointer transition-opacity hover:opacity-90 flex-shrink-0"\n                        aria-label="Fechar chat"\n                    >\n                        <i \n                        data-lucide="x" \n                        style="width: 16px; height: 16px; color: ${t?"#ffffff":"#000000"};"\n                        ></i>\n                    </button>\n                    </div>\n                    <div\n                    class="flex-1 flex overflow-y-auto flex-col"\n                    style="${this.theme.wallpaper_url?`background-image: url(${this.theme.wallpaper_url}); background-size: cover; background-position: center;`:this.theme.bodyColor?`background: ${this.theme.bodyColor};`:""}"\n                    >\n                    <div\n                        id="ttm-messages"\n                        class="flex-1 p-2  flex flex-col gap-2 bg-transparent"\n                    >\n                    </div>\n       \n                    <div class="p-2 flex-shrink-0">\n                        <div\n                        class="flex flex-col p-1 gap-0 border-2 rounded-[1.5rem]"\n                        style="background: ${t?"#212224":"#e9e9e9"}; border: none;"\n                        >\n                        <textarea\n                            type="text"\n                            id="ttm-input"\n                            class="flex p-1 w-full border-none bg-transparent h-[36px] resize-none max-h-[100px] line-height-1.5 overflow-y-auto outline-none text-sm"\n                            style="\n                            color: ${t?"#ffffff":"#000000"};\n                            padding-top: 10px;\n                            padding-left: 1rem;\n                            box-sizing: border-box;\n                            "\n                            placeholder="Digite aqui sua mensagem..."\n                            maxlength="1000"\n                        ></textarea>\n                        <div class="flex flex-row items-center justify-between w-full gap-2">\n                            <div class="flex-1"></div>\n                            <button\n                            id="ttm-send-button"\n                            type="button"\n                            class="w-8 h-8 rounded-full flex items-center justify-center self-end m-1.5 border-none cursor-pointer transition-opacity hover:opacity-90 flex-shrink-0"\n                            style="background: ${t?"#ffffff":"#000000"};"\n                            aria-label="Enviar mensagem"\n                            >\n                            <i \n                                data-lucide="arrow-up" \n                                style="width: 16px; height: 16px; color: ${t?"#000000":"#ffffff"};"\n                            ></i>\n                            </button>\n                        </div>\n                        </div>\n                    </div>\n                    </div>\n                </div>\n                </div>\n            `,document.body.appendChild(this.container),this.chatWindow=document.getElementById("ttm-chat-window"),this.buttonIcon=document.getElementById("ttm-button-icon"),this.inputField=document.getElementById("ttm-input"),this.chatContent=document.getElementById("ttm-chat-content"),this.sendButton=document.getElementById("ttm-send-button"),this.messagesContainer=document.getElementById("ttm-messages"),this.closeButton=document.getElementById("ttm-close-button"),this.audioStream=null,this.lucide.createIcons(),this.chatWindow.addEventListener("click",t=>{this.isOpen||this._openChat()}),this.closeButton.addEventListener("click",t=>{t.stopPropagation(),t.preventDefault(),this._closeChat()}),this.sendButton?.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation(),this.inputField?.value.length>0&&this._sendMessage()}),this.inputField?.addEventListener("keypress",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this._sendMessage())}),this.inputField?.addEventListener("input",t=>{t.target.style.height="30px";const e=Math.min(t.target.scrollHeight,100);t.target.style.height=e+"px",this._updateSendButtonIcon()})}_updateSendButtonIcon(){this.inputField?.value.length,this.lucide.createIcons()}_visualizer(){const t=document.createElement("div");t.id="ttm-visualizer-overlay",t.className="ttm-visualizer-overlay fixed top-0 left-0 w-[100vw] h-[100vh] z-[99999] bg-black/70 backdrop-blur-md justify-center items-center ",t.style.cssText="\n                display: none;\n            ";const e=document.createElement("div");e.id="ttm-visualizer-container",e.className="ttm-visualizer-container relative max-w-[90vw] max-h-[90vh]  flex justify-center items-center";const n=document.createElement("button");n.id="ttm-visualizer-close-button",n.className="ttm-visualizer-close-button fixed top-[10px] right-[10px] w-[40px] h-[40px] rounded-full border-none bg-transparent flex p-0  z-[100000] items-center justify-center cursor-pointer",n.innerHTML='<i data-lucide="x" style="width: 24px; height: 24px; color: #ffffff;"></i>';const i=document.createElement("div");i.id="ttm-visualizer-media-container",i.className="ttm-visualizer-media-container relative w-[100%] h-[100%] flex justify-center items-center",e.appendChild(n),e.appendChild(i),t.appendChild(e),document.body.appendChild(t),this.openVisualizer=e=>{i.innerHTML="";const n=document.createElement("img");n.src=e,n.style.cssText="\n                min-width: 70px;\n                min-height: 70px;\n                max-width: 100%;\n                max-height: 90vh;\n                border-radius: 8px;\n                object-fit: contain;\n                ",i.appendChild(n),t.style.display="flex",this.lucide.createIcons()},n.addEventListener("click",()=>{t.style.display="none"}),t.addEventListener("click",e=>{e.target===t&&(t.style.display="none")}),document.addEventListener("keydown",e=>{"Escape"===e.key&&"flex"===t.style.display&&(t.style.display="none")}),document.addEventListener("click",t=>{if(t.target.classList.contains("ttm-media-visualizer")){if("VIDEO"===t.target.tagName)return;const e=t.target.dataset.mediaSrc,n=t.target.dataset.mediaType;e&&n&&this.openVisualizer(e,n)}})}_injectCustomStyles(){const t="dark"===this.theme.theme,e=`\n                #ttm-chat-container * {\n                box-sizing: border-box;\n                }\n        \n                @keyframes ttm-slide-in {\n                from {\n                    opacity: 0;\n                    transform: translateY(10px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateY(0);\n                }\n                }\n                @keyframes ttm-pulse {\n                0% {\n                    transform: scale(1);\n                }\n                50% {\n                    transform: scale(1.1);\n                }\n                100% {\n                    transform: scale(1);\n                }\n                }\n        \n                .ttm-message-customer {\n                display: flex;\n                justify-content: flex-end !important;\n                }\n\n                #ttm-drop-zone.ttm-drag-over {\n                border-color: #3b82f6 !important;\n                background: ${t?"#1e3a5f":"#dbeafe"} !important;\n                transform: scale(1.02);\n                transition: all 0.2s ease;\n                }\n\n                #ttm-drop-zone {\n                transition: all 0.2s ease;\n                }\n                @keyframes ttm-drag-pulse {\n                    0%, 100% {\n                        opacity: 1;\n                    }\n                    50% {\n                        opacity: 0.8;\n                    }\n                }\n                #ttm-drop-zone.ttm-drag-over {\n                animation: ttm-drag-pulse 1s ease-in-out infinite;\n                }\n\n                .ttm-message {\n                pointer-events: auto;\n                touch-action: pan-y;\n                animation: ttm-slide-in 0.3s ease-in-out;\n                }\n\n                #ttm-input {\n                box-sizing: border-box !important;\n                overflow-y: auto !important;\n                font-family: inherit !important;\n                }\n        \n                #ttm-input::placeholder {\n                color: ${t?"#e5e7eb":"#0D0D0D"} !important;\n                }\n        \n                #ttm-messages::-webkit-scrollbar {\n                width: 6px;\n                }\n\n                #ttm-messages::-webkit-scrollbar-thumb {\n                background: ${t?"#404040":"#d1d5db"};\n                border-radius: 3px;\n                }\n\n                #ttm-messages {\n                -webkit-overflow-scrolling: touch;\n                overscroll-behavior: contain;\n                touch-action: pan-y;\n                overflow-y: scroll !important;\n                -webkit-transform: translateZ(0);\n                }\n        \n                #ttm-input::-webkit-scrollbar {\n                width: 8px;\n                }\n        \n                #ttm-input::-webkit-scrollbar-track {\n                background: transparent;\n                border-radius: 4px;\n                }\n        \n                #ttm-input::-webkit-scrollbar-thumb {\n                background: ${t?"#666":"#888"};\n                border-radius: 4px;\n                }\n\n                .ttm-agent-typing {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 4px;\n                }\n\n                .ttm-agent-typing-dot {\n                width: 8px;\n                height: 8px;\n                border-radius: 50%;\n                background-color: ${t?"#ffffff":"#000000"};\n                animation: ttm-typing-dot 1.4s infinite ease-in-out;\n                }\n\n                .ttm-agent-typing-dot:nth-child(1) {\n                    animation-delay: 0s;\n                }\n\n                .ttm-agent-typing-dot:nth-child(2) {\n                    animation-delay: 0.2s;\n                }\n\n                .ttm-agent-typing-dot:nth-child(3) {\n                    animation-delay: 0.4s;\n                }\n\n                @keyframes ttm-typing-dot {\n                    0%, 60%, 100% {\n                        opacity: 0.3;\n                        transform: scale(0.8);\n                    }\n                    30% {\n                        opacity: 1;\n                        transform: scale(1);\n                    }\n                }\n\n\n                @keyframes ttm-pulse {\n        \n                @media (max-width: 480px) {\n                #ttm-chat-window[data-open="true"] {\n                    width: calc(100vw - 20px) !important;\n                    height: calc(100vh - 100px) !important;\n                    right: 10px !important;\n                }\n                }\n        \n                [data-lucide] {\n                display: inline-block;\n                }\n            `,n=document.createElement("style");n.setAttribute("data-ttm-styles","true"),n.textContent=e,document.head.appendChild(n)}_openChat(){this.isOpen=!0,this.chatWindow.classList.add("overflow-hidden"),this.chatWindow.setAttribute("data-open","true"),this.chatWindow.style.cursor="default",this.buttonIcon.style.opacity="0",this.buttonIcon.style.display="none",this.chatContent.style.display="flex",this.chatWindow.style.transition="all 0.35s ease",this.chatWindow.style.width="343px",this.chatWindow.style.height="550px",this.chatWindow.style.borderRadius="14px",this.chatContent.style.opacity="1",this.chatContent.style.pointerEvents="auto",this._resetNotificationCounter(),this.ws||this.channelInactive||this._connectWebSocket()}_closeChat(){this.isOpen=!1,this.chatWindow.setAttribute("data-open","false"),this.chatWindow.style.cursor="pointer",this.chatContent.style.opacity="0",this.chatContent.style.pointerEvents="none",this.chatContent.style.display="none",this.buttonIcon.style.display="flex",this.buttonIcon.style.opacity="1",this.chatWindow.style.width="44px",this.chatWindow.style.height="44px",this.chatWindow.style.borderRadius="24px",this.chatWindow.classList.remove("overflow-hidden"),this.lucide.createIcons(),this.activeRecorder&&"recording"===this.activeRecorder.state&&(this.activeRecorder.stop(),this.activeRecorder=null),this.dragCounter=0,this.dragTimeout&&(clearTimeout(this.dragTimeout),this.dragTimeout=null)}_updateUIWithNewTheme(){if(!this.container||!this.theme)return;const t="dark"===this.theme.theme,e=this.theme.icon||"message-circle",n=this.buttonIcon?.querySelector("[data-lucide]");n&&(n.setAttribute("data-lucide",e),n.style.color=t?"#ffffff":"#000000",this.lucide?.createIcons());const i=this.chatContent?.querySelector(".p-1");if(i&&(i.style.background=this.theme.headerColor),this.theme.logo_url){const t=this.chatContent?.querySelector('img[alt="Logo"]');t&&(t.src=this.theme.logo_url)}const s=this.chatContent?.querySelector("h3");s&&(s.textContent=this.theme.name||"Chat")}_displayPresence(){const t="dark"===this.theme.theme,e=t?"#000000":"#ebeaea",n=t?"#ffffff":"#000000",i=document.createElement("div");i.className="ttm-message-agent ttm-presence",i.style.color=n,i.innerHTML=`\n         <div \n            class="relative w-fit max-w-[80%] h-full rounded-xl px-2 py-2"\n            style="\n                background: ${e};\n                color: ${n};\n                border: solid 1px ${t?"transparent":"#d1d8db"};\n            "\n            >\n\n            <div class="ttm-agent-typing">\n                <div class="ttm-agent-typing-dot"></div>\n                <div class="ttm-agent-typing-dot"></div>\n                <div class="ttm-agent-typing-dot"></div>\n           </div>\n          </div>\n        `,this.messagesContainer.appendChild(i),this.messagesContainer&&!this.userIsScrolling&&requestAnimationFrame(()=>{this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight})}_clearPresence(){const t=document.querySelector(".ttm-presence");t&&t.remove()}_displayMessage(e){const n="dark"===this.theme.theme,i="customer"===e.origin,s="customer"!=e.origin,a=document.createElement("div");a.className=`ttm-message ${i?"ttm-message-customer":"ttm-message-agent"} ${s?"ttm-message-talk-to-me":""}`;const o=s?n?"#000000":"#ebeaea":i&&n?"#ffffff":"#000000",r=s?n?"#ffffff":"#000000":i?n?"#000000":"#ffffff":"#000000";if(a.innerHTML=`\n            <div \n            class="relative w-fit max-w-[80%] h-full rounded-xl px-2 py-2 break-words"\n            style="\n                background: ${o};\n                color: ${r};\n                ${i?`border: solid 1px ${n?"#d1d5db":"transparent"};`:""}\n                ${s?`border: solid 1px ${n?"transparent":"#d1d5db"};`:""}\n            "\n            >\n            ${e.media?.content_type?.startsWith("image")?`\n            <img \n                src="${e.media.file}" \n                alt="Preview da imagem" \n                class="w-full max-w-[280px] h-auto ttm-media-visualizer cursor-pointer rounded-md object-cover" \n                data-media-src="${e.media.file}"\n                data-media-type="image"\n            />\n            `:""}\n            ${e.media?.content_type?.startsWith("video")?`\n                <video \n                src="${e.media.file}" \n                alt="Preview do vídeo" \n                class="w-full max-w-[280px] h-auto ttm-media-visualizer cursor-pointer rounded-md object-cover" \n                data-media-src="${e.media.file}"\n                data-media-type="video"\n                controls\n                >\n                </video>\n            `:""}\n            ${e.media?.content_type?.startsWith("audio")?`\n            <div class="ttm-audio-player " \n                style="\n                    width: 220px; \n                    border-radius: 8px;\n                    display: flex;\n                    justify-content: start;\n                    align-items: center;\n                    gap: 6px;\n                    background: transparent;\n            ">\n                <button \n                class="ttm-audio-play-btn border-none w-[32px] h-[32px] rounded-full flex items-center justify-center" \n                data-audio-src="${e.media.file}"\n                style="\n                    background: ${s?n?"#ffffff":"#000000":i?n?"#1a1a1a":"#ffffff":"transparent"};\n                    color: ${s?n?"#000000":"#ffffff":i?n?"#ffffff":"#000000":"transparent"};               \n                    transition: opacity 0.2s;\n                "\n                aria-label="Play/Pause áudio"\n                >\n                    <i data-lucide="play" style="width: 18px; height: 18px; margin-left: 2px; fill: ${s?n?"#000000":"#ffffff":i?n?"#ffffff":"#000000":"transparent"};"></i>\n                </button>\n                <div style="flex: 1; display: flex; flex-direction: column;">\n                    <div style="\n                    width: 100%;\n                    height: 32px;\n                    display: flex;\n                    border-radius: 4px;\n                    align-items: center;\n                    justify-content: space-between;\n                    gap: 2px;\n                    top: 5px;\n                    cursor: pointer;\n                    position: relative;\n                    " class="ttm-audio-waveform" data-progress="0">\n                    ${Array.from({length:50},(t,e)=>`\n                        <div style="\n                        flex: 1;\n                        height: 20%;\n                        background: ${n?"#000000":"#d1d5db"};\n                        border-radius: 2px;\n                        transition: all 0.3s ease;\n                        " class="ttm-waveform-bar" data-bar-index="${e}"></div>\n                    `).join("")}\n                    </div>\n                    <div style="\n                    display: flex;\n                    justify-content: end;\n                    font-size: 11px;\n                    color: ${r};\n                    opacity: 0.7;\n                    ">\n                    <span class="ttm-audio-current-time">0:00</span>\n                    <span class="ttm-audio-separator"> / </span>\n                    <span class="ttm-audio-duration">0:00</span>\n                    </div>\n                </div>\n                <audio class="ttm-audio-element" preload="metadata" style="display: none;">\n                    <source src="${e.media.file}" type="${e.media.content_type}">\n                </audio>\n            </div>\n        `:""}\n        ${!e.media||e.media.content_type?.startsWith("image")||e.media.content_type?.startsWith("video")||e.media.content_type?.startsWith("audio")?"":`\n            <div\n            class="ttm-file-download"\n            style="\n                display: flex;\n                align-items: center;\n                gap: 12px;\n                padding: 4px;\n                border-radius: 8px;\n                text-decoration: none;\n                color: ${r};\n                transition: all 0.2s;\n                max-width: 280px;\n            "\n            >\n            <div style="\n                width: 40px;\n                height: 40px;\n                background: ${n?"#1a1a1a":"#e9e9e9"};\n                border-radius: 8px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                flex-shrink: 0;\n            ">\n                <i data-lucide="file" style="width: 20px; height: 20px; color: ${n?"#ffffff":"#000000"};"></i>\n            </div>\n            <div \n                style="\n                flex: 1;\n                min-width: 0;\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n                ">\n                <span style="\n                font-size: 14px;\n                font-weight: 500;\n                color: ${r};\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n                ">\n                ${e.media.file.split("/").pop().split("?")[0]||"Arquivo"}\n                </span>\n                <span style="\n                font-size: 12px;\n                color: ${r};\n                opacity: 0.7;\n                ">\n                ${e.media.content_type||"Documento"}\n                </span>\n            </div>\n            <a             \n            href="${e.media.file}" \n            class="ttm-download-btn"\n            data-file-url="${e.media.file}"\n            data-file-name="${e.media.file.split("/").pop().split("?")[0]}"\n            style="\n                cursor: pointer;\n                width: 32px;\n                height: 32px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                flex-shrink: 0;\n                transition: all 0.2s;\n            ">\n                <i data-lucide="download" style="width: 18px; height: 18px; color: ${r}; opacity: 0.7;"></i>\n            </a>\n            </div>\n        `}\n            ${e.text?`<p class="text-sm m-0 whitespace-normal break-words">${e.text}</p>`:""}\n            ${e.interactive&&"button"===e.interactive.type?`\n                <div class="flex mt-2  flex-col gap-1">\n                ${e.interactive.options.map(t=>`\n                <button class="w-full px-6 py-2 rounded-lg h-full cursor-pointer" \n                style="\n                background: ${n?"#ffffff":"#181818"};\n                border: none; \n                color: ${n?"#000000":"#ffffff"};\n                "\n                data-option-label="${t.label}" onmouseover="this.style.background='${n?"#f0f0f0":"#282828"}'"\n                onmouseout="this.style.background='${n?"#ffffff":"#181818"}'"\n                >\n                    ${t.label} \n                </button>\n                `).join("")}\n                </div>\n            `:""}\n            </div>\n\n            ${"AI"===e.origin&&e.metadata?.ai_agent?.name?`<span class="text-xs m-0 mt-1 whitespace-normal break-words" style="opacity: 0.7; color: ${r};">${e.metadata.ai_agent.name}</span>`:""}\n        `,this.messagesContainer.appendChild(a),this.lucide.createIcons(),this._initAudioPlayers(),e.media&&!e.media.content_type?.startsWith("image")&&!e.media.content_type?.startsWith("audio")){const e=a.querySelector(".ttm-download-btn");e&&e.addEventListener("click",async n=>{n.preventDefault();const i=e.dataset.fileUrl,s=e.dataset.fileName;try{const e=await fetch(i),n=await e.blob(),a=t.URL.createObjectURL(n),o=document.createElement("a");o.style.display="none",o.href=a,o.download=s,document.body.appendChild(o),o.click(),t.URL.revokeObjectURL(a),document.body.removeChild(o)}catch(t){}})}e.interactive?.options&&a.querySelectorAll("button[data-option-label]").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),this._sendMessage(t.dataset.optionLabel)})}),this.messagesContainer&&!this.userIsScrolling&&requestAnimationFrame(()=>{this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight})}}}(window);