/* TalkToMeChat SDK v1.0.0 | (c) 2025 */
!function(e){"use strict";e.TalkToMeChat=class TalkToMeChat{constructor(e){if(this.token=e.token,!this.token)throw new Error('TalkToMe: token é obrigatório. Configure no constructor: new TalkToMeChat({ token: "..." })');this.wsUrl=e.wsUrl,this.theme=null,this.threadId=localStorage.getItem("ttm_thread_id")||null,this.ws=null,this.sessionId=this._generateSessionId(),this.isOpen=!1,this.userIdentifier=this._getUserIdentifier(),this.container=null,this.chatWindow=null,this.messagesContainer=null,this.inputField=null,this.librariesLoaded=!1,this.Motion=null,this.lucide=null,this.displayedMessages=new Set,this.messagesLoaded=!1,this.pendingWebSocketMessages=[],this.messagesQueue=[],this.isProcessingQueue=!1,this._unreadCount=0,this._waitingForHistory=!1}async init(){await this._loadLibraries();const e=await this._fetchConfig();this.name=e.name||"Chat",e.widget_style?this.theme={...e.widget_style,name:e.name||"Chat",theme:e.widget_style.theme||"dark",logo_url:e.widget_style.logo||null,wallpaper_url:e.widget_style.wallpaper||null}:e.metadata?this.theme={...e.metadata,name:e.name||"Chat"}:this.theme={theme:"dark",name:e.name||"Chat",color:e.color||"#151619",icon:e.icon||"message-circle",logo_url:e.logo||null,wallpaper_url:e.wallpaper||null},this._createUI(),this._connectWebSocket()}_generateSessionId(){return"session_"+Math.random().toString(36).substring(2,15)+Date.now().toString(36)}_getUserIdentifier(){let e=localStorage.getItem("ttm_user_id");return e||(e=Math.random().toString(36).substring(2,15),localStorage.setItem("ttm_user_id",e)),e}async _loadLibraries(){if(!this.librariesLoaded)try{await Promise.all([this._loadTailwind(),this._loadFramerMotion(),this._loadLucide()]),this.librariesLoaded=!0}catch(e){}}_loadTailwind(){return new Promise((t,n)=>{if(document.querySelector('script[src*="tailwindcss"]'))return void t();const i=document.createElement("script");i.src="https://cdn.tailwindcss.com",i.onload=()=>{e.tailwind&&(e.tailwind.config={corePlugins:{preflight:!1}}),t()},i.onerror=()=>n(new Error("Falha ao carregar Tailwind CSS")),document.head.appendChild(i)})}_loadFramerMotion(){return new Promise((t,n)=>{if(e.Motion)return this.Motion=e.Motion,void t();const i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/framer-motion@11/dist/framer-motion.js",i.onload=()=>{this.Motion=e.Motion,t()},i.onerror=()=>n(new Error("Falha ao carregar Framer Motion")),document.head.appendChild(i)})}_loadLucide(){return new Promise((t,n)=>{if(e.lucide)return this.lucide=e.lucide,void t();const i=document.createElement("script");i.src="https://unpkg.com/lucide@latest",i.onload=()=>{this.lucide=e.lucide,t()},i.onerror=()=>n(new Error("Falha ao carregar Lucide")),document.head.appendChild(i)})}_connectWebSocket(){const e=`${this.wsUrl}/ws/session:${this.sessionId}/${this.threadId||"new"}?token=${this.token}`;this.ws=new WebSocket(e),this.ws.onopen=()=>{this.messagesLoaded||this._loadMessages()},this.ws.onerror=e=>{alert("TTM: WS error: "+e)},this.ws.onmessage=e=>{const t=JSON.parse(e.data);if("history"===t.type&&t.data){const e=t.data.thread_id;return e&&(this.threadId=e,localStorage.setItem("ttm_thread_id",this.threadId)),t.data.messages&&Array.isArray(t.data.messages)&&t.data.messages.forEach(e=>{this.pendingWebSocketMessages.push(e)}),void(this._waitingForHistory=!1)}if("message"===t.type&&t.data){const e=t.data,n=e.thread_id;n&&(this.threadId=n,localStorage.setItem("ttm_thread_id",this.threadId)),this.messagesLoaded?(this._enqueueMessage(e,!0),this.isOpen||"customer"===e.origin||(this._unreadCount++,this._updateNotificationCounter())):this.pendingWebSocketMessages.push(e)}"finish"===t.type&&this._clearThreadData()}}async _sendMessage(t=null,n=null){const i=t||this.inputField.value,s=e.location.hostname||e.location.host||"",a=`user_${this.userIdentifier}_${s}`;if(i){if(t||(this.inputField.value="",this.inputField.style.height="auto",this._updateSendButtonIcon()),i){const e={text:i||null,origin:"customer",created_at:(new Date).toISOString(),timestamp:(new Date).getTime()};this._enqueueMessage(e),this._processMessageQueue()}this.ws&&this.ws.readyState===WebSocket.OPEN||(this._connectWebSocket(),await new Promise(e=>setTimeout(e,1e3))),this.ws.send(JSON.stringify({type:"send_message",data:{token:this.token,name:a,user_id:this.userIdentifier,text:i||null,metadata:{origin:s},thread_id:this.threadId}}))}}_initAudioPlayers(){document.querySelectorAll(".ttm-audio-player").forEach(async t=>{const n=t.querySelector(".ttm-audio-play-btn"),i=t.querySelector(".ttm-audio-element"),s=t.querySelector(".ttm-audio-waveform"),a=t.querySelector(".ttm-audio-current-time"),o=t.querySelector(".ttm-audio-duration"),r=t.closest(".ttm-message-talk-to-me"),d=t.closest(".ttm-message-customer");if(t.dataset.waveformProcessed)return;t.dataset.waveformProcessed="true";const l=s.querySelector(".ttm-waveform-bar"),c=e.getComputedStyle(l).backgroundColor,h=c.includes("0, 0, 0")||c.includes("rgb(0");let u=!1;const m=i.querySelector("source").src,p=await this._generateWaveformData(m,30),f=s.querySelectorAll(".ttm-waveform-bar");p.forEach((e,t)=>{f[t]&&(f[t].style.height=`${e}%`)});const g=e=>`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`;i.load(),i.addEventListener("loadedmetadata",()=>{o.textContent=g(i.duration)}),i.addEventListener("timeupdate",()=>{const e=i.currentTime/i.duration*100,t=s.querySelectorAll(".ttm-waveform-bar"),n=Math.floor(e/100*t.length);t.forEach((e,t)=>{e.style.background=t<n?r?h?"#ffffff":"#000000":d?h?"#000000":"#ffffff":"#909090":"#909090"}),a.textContent=g(i.currentTime)}),i.addEventListener("ended",()=>{u=!1;const e=n.querySelector("i, svg");e&&(e.setAttribute("data-lucide","play"),e.style.marginLeft="2px"),s.querySelectorAll(".ttm-waveform-bar").forEach(e=>{e.style.background="#909090"}),a.textContent="0:00",this.lucide.createIcons()}),n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const t=n.querySelector("i, svg");u?(i.pause(),t.setAttribute("data-lucide","play"),t.style.marginLeft="2px"):(document.querySelectorAll(".ttm-audio-element").forEach(e=>{if(e!==i){e.pause();const t=e.closest(".ttm-audio-player").querySelector(".ttm-audio-play-btn").querySelector("i, svg");t&&(t.setAttribute("data-lucide","play"),t.style.marginLeft="2px")}}),i.play(),t.setAttribute("data-lucide","pause"),t.style.marginLeft="0"),u=!u,this.lucide.createIcons()}),s.addEventListener("click",e=>{const t=s.getBoundingClientRect(),n=(e.clientX-t.left)/t.width;i.currentTime=n*i.duration})})}async _generateWaveformData(t,n=30){const i=await fetch(t),s=await i.arrayBuffer(),a=new(e.AudioContext||e.webkitAudioContext),o=(await a.decodeAudioData(s)).getChannelData(0),r=n,d=Math.floor(o.length/r),l=[];for(let e=0;e<r;e++){let t=d*e,n=0;for(let e=0;e<d;e++)n+=Math.abs(o[t+e]);l.push(n/d)}const c=Math.max(...l),h=Math.min(...l),u=c-h,m=l.map(e=>{if(0===u)return 20;const t=(e-h)/u;return Math.floor(60*t)+20});return a.close(),m}_audioRecorder(e){const t=["audio/ogg; codecs=opus","audio/webm; codecs=opus","audio/webm"].find(e=>MediaRecorder.isTypeSupported(e))||"",n=new MediaRecorder(e,{mimeType:t});let i=0;return this.recordingInterval=setInterval(()=>{i++;const e=`${Math.floor(i/60)}:${(i%60).toString().padStart(2,"0")}`;this._setRecordingButtonStyle(!0,e)},1e3),this._setRecordingButtonStyle(!0,"0:00"),n.addEventListener("dataavailable",e=>{if(e.data.size>0){const n=t.includes("ogg")?"ogg":"webm",i=new File([e.data],`audio.${n}`,{type:t});this._sendMessage(null,[i])}}),n.addEventListener("stop",()=>{this.recordingInterval&&(clearInterval(this.recordingInterval),this.recordingInterval=null),this._setRecordingButtonStyle(!1,"0:00"),this.activeRecorder=null,e.getTracks().forEach(e=>e.stop()),this.audioStream=null}),n.start(),n}_setRecordingButtonStyle(e,t="0:00"){if(!this.sendButton)return;const n="dark"===this.theme.theme;e?(this.originalPlaceholder||(this.originalPlaceholder=this.inputField.placeholder),this.sendButton.style.background="#ef4444",this.sendButton.style.animation="ttm-pulse 1.5s ease-in-out infinite",this.sendButton.innerHTML='<i data-lucide="stop" style="width: 16px; height: 16px;"></i>',this.inputField.placeholder=`Gravando... ${t}`):(this.sendButton.style.background=n?"#ffffff":"#000000",this.sendButton.style.border="none",this.sendButton.style.animation="",this.originalPlaceholder&&(this.inputField.placeholder=this.originalPlaceholder,this.originalPlaceholder=null),this._updateSendButtonIcon()),this.lucide.createIcons()}_clearThreadData(){localStorage.removeItem("ttm_thread_id"),localStorage.removeItem("ttm_user_id"),this.threadId=null,this.messagesLoaded=!1,this.displayedMessages.clear(),this.messagesQueue=[],this.pendingWebSocketMessages=[],this.userIdentifier=this._getUserIdentifier(),this.messagesContainer&&(this.messagesContainer.innerHTML="")}async _loadMessages(){if(!this.messagesLoaded){if(this.threadId&&this.ws&&this.ws.readyState===WebSocket.OPEN){this._waitingForHistory=!0,this.ws.send(JSON.stringify({type:"history",data:{thread_id:this.threadId,token:this.token}}));const e=3e3,t=Date.now();for(;this._waitingForHistory&&Date.now()-t<e;)await new Promise(e=>setTimeout(e,100))}this.messagesLoaded=!0,this._processPendingMessages()}}async _processMessageQueue(){if(!this.isProcessingQueue&&0!==this.messagesQueue.length){for(this.isProcessingQueue=!0;this.messagesQueue.length>0;){const e=this.messagesQueue.shift();this._displayMessage(e),e.isNewMessage&&await new Promise(e=>setTimeout(e,500))}this.isProcessingQueue=!1}}_enqueueMessage(e,t=!1){const n=`${e.text||""}_${e.origin}_${e.created_at||e.timestamp||""}`;this.displayedMessages.has(n)||(this.displayedMessages.add(n),e.isNewMessage=t,this.messagesQueue.push(e),this._processMessageQueue())}_notification(){const e=document.querySelector(".ttm-notification-counter");if(e){const t=this._unreadCount||0;t>0?(e.querySelector("span").textContent=t,e.classList.remove("hidden")):e.classList.add("hidden")}}_updateNotificationCounter(){const e=document.querySelector(".ttm-notification-counter");if(e){const t=this._unreadCount||0;t>0?(e.querySelector("span").textContent=t,e.classList.remove("hidden")):e.classList.add("hidden")}}_resetNotificationCounter(){this._unreadCount=0,this._updateNotificationCounter()}_processPendingMessages(){this.pendingWebSocketMessages.length>0&&(this.pendingWebSocketMessages.forEach(e=>{this._enqueueMessage(e)}),this.pendingWebSocketMessages=[])}async _fetchConfig(){const e=await this._extractSchemaNameFromToken(this.token),t=this.wsUrl.replace("wss://","https://").replace("ws://","http://"),n=await fetch(`${t}/api/webhook/widget/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.token})});if(!n.ok)throw new Error("Failed to fetch config");const i=await n.json();if("ok"===i.status&&"metadata"===i.type)return{name:i.name,...i.data,metadata:i.data,widget_style:i.data.widget_style};throw new Error("Invalid response from API")}async _extractSchemaNameFromToken(e){const t=e.split(":");if(2===t.length)return t[1]}_createUI(){const e="dark"===this.theme.theme,t=this.theme.color||"#151619";this._injectCustomStyles(),this.container=document.createElement("div"),this.container.id="ttm-chat-container",this._visualizer();const n=this.theme.icon||"message-circle";this.container.innerHTML=`\n                    <div\n                    id="ttm-chat-window"\n                    class="fixed flex flex-col border-2 shadow-2xl cursor-pointer"\n                    style="\n                        background: ${e?"#151619":"#f9fafb"};\n                        bottom: 20px;\n                        right: 20px;\n                        border-radius: 24px;\n                        z-index: 9999;\n                        border: none;\n                        width: 46px;\n                        height: 46px;\n                    "\n                    aria-label="Abrir chat"\n                    >\n                    <div\n                        id="ttm-button-icon"\n                        type="button"\n                        class="absolute inset-0 flex items-center justify-center"\n                        style="opacity: 1;"\n                    >\n                        <i\n                        data-lucide="${n}"\n                        class="size-5"\n                        style="color: ${e?"#ffffff":"#000000"};"\n                        ></i>\n                    </div>\n                    <div class="ttm-notification-counter absolute min-w-[20px] h-5 px-1.5 rounded-full bg-red-500 hidden flex items-center justify-center border-2 border-white" style="top: -4px; right: 4px; z-index: 10000; transform: translate(6px, -6px);">\n                        <span class="text-[11px] text-white font-semibold leading-none">0</span>\n                    </div>\n                    <div\n                        id="ttm-chat-content"\n                        class="flex flex-col h-full"\n                        style="opacity: 0; pointer-events: none; display: none; position: relative;"\n                        >\n                        <div\n                        class="p-1 flex items-start gap-2 flex-shrink-0"\n                        style="background: ${t};  border-bottom: 1px solid ${e?"#565656":"#d1d5db"};"\n                        >\n                        ${this.theme.logo_url?`\n                            <div \n                            class="mt-1 ml-3 w-[2.5rem] h-[2.5rem] rounded-full border-2 flex items-center justify-center flex-shrink-0"\n                            style="background: ${e?"#494949":"#d4d4d4"};"\n                            >\n                            <img \n                                src="${this.theme.logo_url}" \n                                alt="Logo" \n                                class="w-[2.5rem] h-[2.5rem] rounded-full object-cover" \n                            />\n                        </div>\n                    `:`            <div \n                            class="mt-1 ml-3 w-[2.5rem] h-[2.5rem] rounded-full border-2 flex items-center justify-center flex-shrink-0"\n                            style="background: ${e?"#494949":"#d4d4d4"};"\n                            >\n                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${e?"#ffffff":"#000000"}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="size-5"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>\n                        </div>`}\n                    <h3\n                        class="flex-1 text-base font-normal mt-[0.9rem] ml-2"\n                        style="color: ${e?"white":"black"};"\n                    >\n                        ${this.theme.name}\n                    </h3>\n                    <button\n                        id="ttm-close-button"\n                        class="w-9 h-9 bg-transparent flex items-center justify-center self-end m-1.5 border-none cursor-pointer transition-opacity hover:opacity-90 flex-shrink-0"\n                        aria-label="Fechar chat"\n                    >\n                        <i \n                        data-lucide="x" \n                        style="width: 16px; height: 16px; color: ${e?"#ffffff":"#000000"};"\n                        ></i>\n                    </button>\n                    </div>\n                    <div\n                    class="flex-1 flex overflow-y-auto flex-col"\n                    style="${this.theme.wallpaper_url?`background-image: url(${this.theme.wallpaper_url}); background-size: cover; background-position: center;`:t?`background: ${t};`:""}"\n                    >\n                    <div\n                        id="ttm-messages"\n                        class="flex-1 p-2  flex flex-col gap-2 bg-transparent"\n                    >\n                    </div>\n                    <div class="p-2 flex-shrink-0">\n                        <div\n                        class="flex flex-col p-1 gap-0 border-2 rounded-[1rem]"\n                        style="background: ${e?"#212224":"#d9d9d9"}; border: none;"\n                        >\n                        \x3c!-- <div\n                            id="ttm-file-preview"\n                            class="hidden flex flex-row items-start gap-2 w-full flex-wrap p-2"\n                        >\n                        </div>\n                        <input\n                            type="file"\n                            id="ttm-file-input"\n                            class="hidden"\n                            accept="image/*,video/*,audio/*,.pdf,.doc,.docx"\n                            multiple\n                        /> --\x3e\n                        <textarea\n                            type="text"\n                            id="ttm-input"\n                            class="flex p-1 w-full border-none bg-transparent h-[36px] resize-none max-h-[100px] line-height-1.5 overflow-y-auto outline-none text-sm"\n                            style="\n                            color: ${e?"#ffffff":"#000000"};\n                            padding-top: 10px;\n                            padding-left: 1rem;\n                            box-sizing: border-box;\n                            "\n                            placeholder="Digite aqui sua mensagem..."\n                            maxlength="1000"\n                        ></textarea>\n                        <div class="flex flex-row items-center justify-between w-full gap-2">\n                            \x3c!-- <button\n                            type="button"\n                            id="ttm-file-button"\n                            class="w-8 h-8 flex items-center justify-center self-end m-1.5 border-none cursor-pointer transition-opacity hover:opacity-90 flex-shrink-0"\n                            style="background: transparent; color: ${e?"#ffffff":"#000000"};"\n                            aria-label="Enviar arquivo"\n                            >\n                            <i \n                                data-lucide="paperclip" \n                                style="width: 16px; height: 16px;"\n                            ></i>\n                            </button> --\x3e\n                            <div class="flex-1"></div>\n                            <button\n                            id="ttm-send-button"\n                            type="button"\n                            class="w-8 h-8 rounded-full flex items-center justify-center self-end m-1.5 border-none cursor-pointer transition-opacity hover:opacity-90 flex-shrink-0"\n                            style="background: ${e?"#ffffff":"#000000"}; color: ${e?"#000000":"#ffffff"};"\n                            aria-label="Enviar mensagem"\n                            >\n                            <i \n                                data-lucide="arrow-up" \n                                style="width: 16px; height: 16px;"\n                            ></i>\n                            </button>\n                        </div>\n                        </div>\n                    </div>\n                    </div>\n                </div>\n                </div>\n            `,document.body.appendChild(this.container),this.chatWindow=document.getElementById("ttm-chat-window"),this.buttonIcon=document.getElementById("ttm-button-icon"),this.inputField=document.getElementById("ttm-input"),this.chatContent=document.getElementById("ttm-chat-content"),this.sendButton=document.getElementById("ttm-send-button"),this.messagesContainer=document.getElementById("ttm-messages"),this.closeButton=document.getElementById("ttm-close-button"),this.audioStream=null,this.lucide.createIcons(),this.chatWindow.addEventListener("click",e=>{this.isOpen||this._openChat()}),this.closeButton.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault(),this._closeChat()}),this.sendButton?.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const t=this.inputField?.value.length>0;if(this.activeRecorder&&"recording"===this.activeRecorder.state)this.activeRecorder.stop();else if(t)this._sendMessage();else if(!t&&!this.activeRecorder)try{this.audioStream&&this.audioStream.active||(this.audioStream=await navigator.mediaDevices.getUserMedia({audio:!0})),this.activeRecorder=this._audioRecorder(this.audioStream)}catch(e){this.audioStream=null,alert("Erro ao acessar o microfone. Verifique as permissões.")}}),this.inputField?.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this._sendMessage())}),this.inputField?.addEventListener("input",e=>{e.target.style.height="30px";const t=Math.min(e.target.scrollHeight,100);e.target.style.height=t+"px",this._updateSendButtonIcon()})}_updateSendButtonIcon(){const e=this.inputField?.value.length>0?"arrow-up":"audio-lines";this.sendButton.innerHTML=`<i data-lucide="${e}" style="width: 16px; height: 16px;"></i>`,this.lucide.createIcons()}_visualizer(){const e=document.createElement("div");e.id="ttm-visualizer-overlay",e.className="ttm-visualizer-overlay fixed top-0 left-0 w-[100vw] h-[100vh] z-[99999] bg-black/70 backdrop-blur-md justify-center items-center ",e.style.cssText="\n                display: none;\n            ";const t=document.createElement("div");t.id="ttm-visualizer-container",t.className="ttm-visualizer-container relative max-w-[90vw] max-h-[90vh]  flex justify-center items-center";const n=document.createElement("button");n.id="ttm-visualizer-close-button",n.className="ttm-visualizer-close-button fixed top-[10px] right-[10px] w-[40px] h-[40px] rounded-full border-none bg-transparent flex p-0  z-[100000] items-center justify-center cursor-pointer",n.innerHTML='<i data-lucide="x" style="width: 24px; height: 24px; color: #ffffff;"></i>';const i=document.createElement("div");i.id="ttm-visualizer-media-container",i.className="ttm-visualizer-media-container relative w-[100%] h-[100%] flex justify-center items-center",t.appendChild(n),t.appendChild(i),e.appendChild(t),document.body.appendChild(e),this.openVisualizer=t=>{i.innerHTML="";const n=document.createElement("img");n.src=t,n.style.cssText="\n                min-width: 70px;\n                min-height: 70px;\n                max-width: 100%;\n                max-height: 90vh;\n                border-radius: 8px;\n                object-fit: contain;\n                ",i.appendChild(n),e.style.display="flex",this.lucide.createIcons()},n.addEventListener("click",()=>{e.style.display="none"}),e.addEventListener("click",t=>{t.target===e&&(e.style.display="none")}),document.addEventListener("keydown",t=>{"Escape"===t.key&&"flex"===e.style.display&&(e.style.display="none")}),document.addEventListener("click",e=>{if(e.target.classList.contains("ttm-media-visualizer")){if("VIDEO"===e.target.tagName)return;const t=e.target.dataset.mediaSrc,n=e.target.dataset.mediaType;t&&n&&this.openVisualizer(t,n)}})}_injectCustomStyles(){const e="dark"===this.theme.theme,t=`\n                #ttm-chat-container * {\n                box-sizing: border-box;\n                }\n        \n                /* Animações customizadas */\n                @keyframes ttm-slide-in {\n                from {\n                    opacity: 0;\n                    transform: translateY(10px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateY(0);\n                }\n                }\n                @keyframes ttm-pulse {\n                0% {\n                    transform: scale(1);\n                }\n                50% {\n                    transform: scale(1.1);\n                }\n                100% {\n                    transform: scale(1);\n                }\n                }\n        \n                .ttm-message-customer {\n                display: flex;\n                justify-content: flex-end !important;\n                }\n                #ttm-drop-zone.ttm-drag-over {\n                border-color: #3b82f6 !important;\n                background: ${e?"#1e3a5f":"#dbeafe"} !important;\n                transform: scale(1.02);\n                transition: all 0.2s ease;\n                }\n                #ttm-drop-zone {\n                transition: all 0.2s ease;\n                }\n                /* Animação para destacar a área de drop */\n                @keyframes ttm-drag-pulse {\n                    0%, 100% {\n                        opacity: 1;\n                    }\n                    50% {\n                        opacity: 0.8;\n                    }\n                }\n                #ttm-drop-zone.ttm-drag-over {\n                animation: ttm-drag-pulse 1s ease-in-out infinite;\n                }\n                .ttm-message {\n                pointer-events: auto;\n                touch-action: pan-y;\n                animation: ttm-slide-in 0.3s ease-in-out;\n                }\n                #ttm-input {\n                box-sizing: border-box !important;\n                overflow-y: auto !important;\n                }\n        \n                /* Placeholder colors */\n                #ttm-input::placeholder {\n                color: ${e?"#e5e7eb":"#4b5563"};\n                }\n        \n                /* Scrollbar styling */\n                #ttm-messages::-webkit-scrollbar {\n                width: 6px;\n                }\n                #ttm-messages::-webkit-scrollbar-thumb {\n                background: ${e?"#404040":"#d1d5db"};\n                border-radius: 3px;\n                }\n                #ttm-messages {\n                -webkit-overflow-scrolling: touch;\n                overscroll-behavior: contain;\n                touch-action: pan-y;\n                overflow-y: scroll !important; /* Forçar scroll sempre visível */\n                -webkit-transform: translateZ(0); /* Força aceleração de hardware */\n                }\n        \n                #ttm-input::-webkit-scrollbar {\n                width: 8px;\n                }\n        \n                #ttm-input::-webkit-scrollbar-track {\n                background: transparent;\n                border-radius: 4px;\n                }\n        \n                #ttm-input::-webkit-scrollbar-thumb {\n                background: ${e?"#666":"#888"};\n                border-radius: 4px;\n                }\n        \n                /* Responsivo */\n                @media (max-width: 480px) {\n                #ttm-chat-window[data-open="true"] {\n                    width: calc(100vw - 20px) !important;\n                    height: calc(100vh - 100px) !important;\n                    right: 10px !important;\n                }\n                }\n        \n                /* Garantir que os ícones Lucide renderizem corretamente */\n                [data-lucide] {\n                display: inline-block;\n                }\n            `,n=document.createElement("style");n.textContent=t,document.head.appendChild(n)}_openChat(){this.isOpen=!0,this.chatWindow.classList.add("overflow-hidden"),this.chatWindow.setAttribute("data-open","true"),this.chatWindow.style.cursor="default",this.buttonIcon.style.opacity="0",this.buttonIcon.style.display="none",this.chatContent.style.display="flex",this.chatWindow.style.transition="all 0.35s ease",this.chatWindow.style.width="343px",this.chatWindow.style.height="550px",this.chatWindow.style.borderRadius="14px",this.chatContent.style.opacity="1",this.chatContent.style.pointerEvents="auto",this._resetNotificationCounter(),this.ws||this._connectWebSocket()}_closeChat(){this.isOpen=!1,this.chatWindow.setAttribute("data-open","false"),this.chatWindow.style.cursor="pointer",this.chatContent.style.opacity="0",this.chatContent.style.pointerEvents="none",this.chatContent.style.display="none",this.buttonIcon.style.display="flex",this.buttonIcon.style.opacity="1",this.chatWindow.style.width="44px",this.chatWindow.style.height="44px",this.chatWindow.style.borderRadius="24px",this.chatWindow.classList.remove("overflow-hidden"),this.lucide.createIcons(),this.activeRecorder&&"recording"===this.activeRecorder.state&&(this.activeRecorder.stop(),this.activeRecorder=null),this.dragCounter=0,this.dragTimeout&&(clearTimeout(this.dragTimeout),this.dragTimeout=null)}_updateUIWithNewTheme(){if(!this.container||!this.theme)return;const e="dark"===this.theme.theme,t=this.theme.color||"#000000",n=this.theme.icon||"message-circle",i=this.buttonIcon?.querySelector("[data-lucide]");i&&(i.setAttribute("data-lucide",n),i.style.color=e?"#ffffff":"#000000",this.lucide?.createIcons());const s=this.chatContent?.querySelector(".p-1");if(s&&(s.style.background=t),this.theme.logo_url){const e=this.chatContent?.querySelector('img[alt="Logo"]');e&&(e.src=this.theme.logo_url)}const a=this.chatContent?.querySelector("h3");a&&(a.textContent=this.theme.name||"Chat")}_displayMessage(t){const n="dark"===this.theme.theme,i="customer"===t.origin,s="customer"!=t.origin,a=document.createElement("div");a.className=`ttm-message ${i?"ttm-message-customer":"ttm-message-agent"} ${s?"ttm-message-talk-to-me":""}`;const o=s?n?"#000000":"#ffffff":i&&n?"#ffffff":"#000000",r=s?n?"#ffffff":"#000000":i?n?"#000000":"#ffffff":"#000000";if(a.innerHTML=`\n            <div \n            class="relative w-fit max-w-[80%] h-full rounded-xl px-2 py-2 break-words"\n            style="\n                background: ${o};\n                color: ${r};\n                ${i?`border: solid 1px ${n?"#d1d5db":"transparent"};`:""}\n                ${s?`border: solid 1px ${n?"transparent":"#d1d5db"};`:""}\n            "\n            >\n            ${t.media?.content_type?.startsWith("image")?`\n            <img \n                src="${t.media.file}" \n                alt="Preview da imagem" \n                class="w-full max-w-[280px] h-auto ttm-media-visualizer cursor-pointer rounded-md object-cover" \n                data-media-src="${t.media.file}"\n                data-media-type="image"\n            />\n            `:""}\n            ${t.media?.content_type?.startsWith("video")?`\n                <video \n                src="${t.media.file}" \n                alt="Preview do vídeo" \n                class="w-full max-w-[280px] h-auto ttm-media-visualizer cursor-pointer rounded-md object-cover" \n                data-media-src="${t.media.file}"\n                data-media-type="video"\n                controls\n                >\n                </video>\n            `:""}\n            ${t.media?.content_type?.startsWith("audio")?`\n            <div class="ttm-audio-player " \n                style="\n                    width: 220px; \n                    border-radius: 8px;\n                    display: flex;\n                    justify-content: start;\n                    align-items: center;\n                    gap: 6px;\n                    background: transparent;\n            ">\n                <button \n                class="ttm-audio-play-btn border-none w-[32px] h-[32px] rounded-full flex items-center justify-center" \n                data-audio-src="${t.media.file}"\n                style="\n                    background: ${s?n?"#ffffff":"#000000":i?n?"#1a1a1a":"#ffffff":"transparent"};\n                    color: ${s?n?"#000000":"#ffffff":i?n?"#ffffff":"#000000":"transparent"};               \n                    transition: opacity 0.2s;\n                "\n                aria-label="Play/Pause áudio"\n                >\n                    <i data-lucide="play" style="width: 18px; height: 18px; margin-left: 2px; fill: ${s?n?"#000000":"#ffffff":i?n?"#ffffff":"#000000":"transparent"};"></i>\n                </button>\n                <div style="flex: 1; display: flex; flex-direction: column;">\n                    <div style="\n                    width: 100%;\n                    height: 32px;\n                    display: flex;\n                    border-radius: 4px;\n                    align-items: center;\n                    justify-content: space-between;\n                    gap: 2px;\n                    top: 5px;\n                    cursor: pointer;\n                    position: relative;\n                    " class="ttm-audio-waveform" data-progress="0">\n                    ${Array.from({length:50},(e,t)=>`\n                        <div style="\n                        flex: 1;\n                        height: 20%;\n                        background: ${n?"#000000":"#d1d5db"};\n                        border-radius: 2px;\n                        transition: all 0.3s ease;\n                        " class="ttm-waveform-bar" data-bar-index="${t}"></div>\n                    `).join("")}\n                    </div>\n                    <div style="\n                    display: flex;\n                    justify-content: end;\n                    font-size: 11px;\n                    color: ${r};\n                    opacity: 0.7;\n                    ">\n                    <span class="ttm-audio-current-time">0:00</span>\n                    <span class="ttm-audio-separator"> / </span>\n                    <span class="ttm-audio-duration">0:00</span>\n                    </div>\n                </div>\n                <audio class="ttm-audio-element" preload="metadata" style="display: none;">\n                    <source src="${t.media.file}" type="${t.media.content_type}">\n                </audio>\n            </div>\n        `:""}\n        ${!t.media||t.media.content_type?.startsWith("image")||t.media.content_type?.startsWith("video")||t.media.content_type?.startsWith("audio")?"":`\n            <div\n            class="ttm-file-download"\n            style="\n                display: flex;\n                align-items: center;\n                gap: 12px;\n                padding: 4px;\n                border-radius: 8px;\n                text-decoration: none;\n                color: ${r};\n                transition: all 0.2s;\n                max-width: 280px;\n            "\n            >\n            <div style="\n                width: 40px;\n                height: 40px;\n                background: ${n?"#1a1a1a":"#e9e9e9"};\n                border-radius: 8px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                flex-shrink: 0;\n            ">\n                <i data-lucide="file" style="width: 20px; height: 20px; color: ${n?"#ffffff":"#000000"};"></i>\n            </div>\n            <div \n                style="\n                flex: 1;\n                min-width: 0;\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n                ">\n                <span style="\n                font-size: 14px;\n                font-weight: 500;\n                color: ${r};\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n                ">\n                ${t.media.file.split("/").pop().split("?")[0]||"Arquivo"}\n                </span>\n                <span style="\n                font-size: 12px;\n                color: ${r};\n                opacity: 0.7;\n                ">\n                ${t.media.content_type||"Documento"}\n                </span>\n            </div>\n            <a             \n            href="${t.media.file}" \n            class="ttm-download-btn"\n            data-file-url="${t.media.file}"\n            data-file-name="${t.media.file.split("/").pop().split("?")[0]}"\n            style="\n                cursor: pointer;\n                width: 32px;\n                height: 32px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                flex-shrink: 0;\n                transition: all 0.2s;\n            ">\n                <i data-lucide="download" style="width: 18px; height: 18px; color: ${r}; opacity: 0.7;"></i>\n            </a>\n            </div>\n        `}\n            ${t.text?`<p class="text-sm m-0 whitespace-normal break-words">${t.text}</p>`:""}\n            ${t.interactive&&"button"===t.interactive.type?`\n                <div class="flex mt-2  flex-col gap-1">\n                ${t.interactive.options.map(e=>`\n                <button class="w-full px-6 py-2 rounded-lg h-full cursor-pointer" \n                style="\n                background: ${n?"#ffffff":"#181818"};\n                border: none; \n                &:hover {\n                    background: ${n?"#f0f0f0":"#282828"}; \n                }\n                color: ${n?"#000000":"#ffffff"};\n                "\n                data-option-label="${e.label}"\n                >\n                    ${e.label}\n                </button>\n                `).join("")}\n                </div>\n            `:""}\n            </div>\n        `,this.messagesContainer.appendChild(a),this.lucide.createIcons(),this._initAudioPlayers(),t.media&&!t.media.content_type?.startsWith("image")&&!t.media.content_type?.startsWith("audio")){const t=a.querySelector(".ttm-download-btn");t&&t.addEventListener("click",async n=>{n.preventDefault();const i=t.dataset.fileUrl,s=t.dataset.fileName;try{const t=await fetch(i),n=await t.blob(),a=e.URL.createObjectURL(n),o=document.createElement("a");o.style.display="none",o.href=a,o.download=s,document.body.appendChild(o),o.click(),e.URL.revokeObjectURL(a),document.body.removeChild(o)}catch(e){}})}t.interactive?.options&&a.querySelectorAll("button[data-option-label]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),this._sendMessage(e.dataset.optionLabel)})}),this.messagesContainer&&!this.userIsScrolling&&requestAnimationFrame(()=>{this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight})}}}(window);